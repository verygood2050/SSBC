<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- Ï∫êÏãú Î∞©ÏßÄ -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>ÏÑúÏÑúÏö∏ÏÑ±ÏÑúÏπ®Î°ÄÍµêÌöå</title>
    <meta name="theme-color" content="#1e3a5f">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&family=Nanum+Myeongjo:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK - Î∞òÎìúÏãú Î®ºÏ†Ä Î°úÎìú -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <!-- Mammoth.js for docx parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <style>
        :root {
            --primary: #1e3a5f;
            --primary-light: #2d5a8a;
            --primary-dark: #0f1f33;
            --accent: #c9a227;
            --bg-warm: #faf8f5;
            --bg-card: #ffffff;
            --text-primary: #2c2c2c;
            --text-secondary: #666666;
            --text-light: #999999;
            --border: #e8e4de;
            --shadow: rgba(30, 58, 95, 0.08);
            --success: #4a9d6e;
            --danger: #c75050;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: var(--bg-warm);
            color: var(--text-primary);
            min-height: 100vh;
            padding-bottom: 80px;
        }

        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 20px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content { max-width: 600px; margin: 0 auto; position: relative; }

        .church-name {
            font-family: 'Nanum Myeongjo', serif;
            font-size: 1.5rem;
            font-weight: 700;
            letter-spacing: 2px;
        }

        .church-subtitle { font-size: 0.75rem; opacity: 0.8; }

        .connection-status {
            position: absolute;
            top: 0;
            right: 0;
            font-size: 0.65rem;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--danger);
        }

        .status-dot.connected { background: var(--success); }

        .main-content { max-width: 600px; margin: 0 auto; padding: 20px; }

        .section { display: none; animation: fadeIn 0.3s ease; }
        .section.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 12px var(--shadow);
            border: 1px solid var(--border);
        }

        .card-title {
            font-family: 'Nanum Myeongjo', serif;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-header-with-btn {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .card-header-with-btn .card-title {
            margin-bottom: 0;
        }

        .card-manage-btn {
            background: var(--bg-warm);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 6px 12px;
            font-size: 0.8rem;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .card-manage-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .link-order-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .link-order-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: white;
            border-radius: 10px;
            border: 1px solid var(--border);
            user-select: none;
            transition: transform 0.15s, box-shadow 0.15s, background 0.15s;
        }

        .link-order-item.sortable-ghost {
            opacity: 0.4;
            background: var(--bg-warm);
        }

        .link-order-item.sortable-chosen {
            background: var(--bg-warm);
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            transform: scale(1.02);
            z-index: 10;
        }

        .link-order-item .drag-handle {
            color: var(--text-light);
            font-size: 1.1rem;
            cursor: grab;
            padding: 4px;
        }

        .link-order-item .drag-handle:active {
            cursor: grabbing;
        }

        .link-order-item .link-icon {
            font-size: 1.3rem;
        }

        .link-order-item .link-name {
            flex: 1;
            font-weight: 500;
            font-size: 0.9rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .link-manage-btns {
            display: flex;
            gap: 4px;
        }

        .link-manage-btns button {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 6px;
            background: var(--bg-warm);
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.2s;
        }

        .link-manage-btns .link-edit-btn:hover {
            background: var(--primary-light);
        }

        .link-manage-btns .link-delete-btn:hover {
            background: #ffebee;
        }

        .thanks-item {
            border-left: 3px solid #e91e63;
        }

        .welcome-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            text-align: center;
            padding: 30px 20px;
        }

        .welcome-card .card-title { color: white; justify-content: center; font-size: 1.3rem; }

        .daily-verse {
            font-family: 'Nanum Myeongjo', serif;
            font-size: 1rem;
            line-height: 1.8;
            margin: 16px 0;
        }

        .verse-reference { font-size: 0.85rem; opacity: 0.8; }

        .quick-links { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }

        .quick-link {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 16px 8px;
            background: var(--bg-card);
            border-radius: 12px;
            text-decoration: none;
            color: var(--text-primary);
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-link:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
        }

        .quick-link .link-icon { font-size: 1.8rem; margin-bottom: 6px; }
        .quick-link .link-text { font-size: 0.8rem; font-weight: 500; }

        .add-link-btn {
            border: 2px dashed var(--border) !important;
            background: transparent !important;
            color: var(--text-light) !important;
        }

        .link-edit-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            background: var(--accent);
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 0.7rem;
            cursor: pointer;
            opacity: 0.8;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .link-edit-btn:hover { opacity: 1; }

        .notice-item {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            position: relative;
        }

        .notice-item:last-child { border-bottom: none; }
        .notice-item:hover { background: var(--bg-warm); }

        .notice-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .notice-title { font-weight: 500; flex: 1; }
        .notice-date { font-size: 0.8rem; color: var(--text-light); }

        .notice-badge {
            background: var(--accent);
            color: white;
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 10px;
            margin-right: 8px;
        }

        .notice-delete {
            position: absolute;
            top: 12px;
            right: 12px;
            background: none;
            border: none;
            color: var(--danger);
            cursor: pointer;
            font-size: 1rem;
            opacity: 0.6;
            padding: 4px;
        }

        .notice-delete:hover { opacity: 1; }

        .month-selector {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            margin-bottom: 20px;
        }

        .month-btn {
            background: var(--primary);
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
        }

        .current-month {
            font-family: 'Nanum Myeongjo', serif;
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary);
        }

        .prayer-item {
            background: var(--bg-warm);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border-left: 4px solid var(--accent);
            position: relative;
        }

        .prayer-author { font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 8px; }
        .prayer-content { font-size: 0.95rem; line-height: 1.6; }
        .prayer-date { font-size: 0.75rem; color: var(--text-light); margin-top: 8px; text-align: right; }

        .prayer-actions {
            position: absolute;
            top: 12px;
            right: 12px;
            display: flex;
            gap: 4px;
        }

        .prayer-actions button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            opacity: 0.5;
            font-size: 1rem;
        }

        .prayer-actions button:hover { opacity: 1; }

        .calendar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            text-align: center;
        }

        .calendar-day-name { font-size: 0.75rem; color: var(--text-light); padding: 8px 0; }
        .calendar-day-name:first-child { color: var(--danger); }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            border-radius: 8px;
            cursor: pointer;
            position: relative;
        }

        .calendar-day:hover { background: var(--bg-warm); }
        .calendar-day.today { background: var(--primary); color: white; }
        .calendar-day.selected { background: #2e7d32; color: white; }
        .calendar-day.other-month { opacity: 0.3; cursor: pointer; }
        .calendar-day.other-month:hover { opacity: 0.6; background: var(--bg-warm); }
        .calendar-day.sunday { color: var(--danger); }
        .calendar-day.today.sunday, .calendar-day.selected.sunday { color: white; }

        /* ÏùºÏ†ï ÏûàÎäî ÎÇ† - Îπ®Í∞Ñ Ï†ê */
        .calendar-day.has-event::after {
            content: '';
            position: absolute;
            bottom: 4px;
            width: 8px;
            height: 8px;
            background: #e74c3c;
            border-radius: 50%;
            box-shadow: 0 0 4px #e74c3c;
        }

        .calendar-day.today.has-event::after,
        .calendar-day.selected.has-event::after { 
            background: #ffeb3b;
            box-shadow: 0 0 4px #ffeb3b;
        }

        .selected-date-info {
            background: var(--bg-warm);
            padding: 16px;
            border-radius: 12px;
            margin-top: 16px;
        }

        .selected-date-title { font-weight: 600; color: var(--primary); margin-bottom: 12px; }

        .schedule-item {
            display: flex;
            gap: 12px;
            padding: 12px;
            background: var(--bg-warm);
            border-radius: 10px;
            margin-bottom: 8px;
            align-items: flex-start;
        }

        .schedule-date { min-width: 50px; text-align: center; }
        .schedule-day { font-size: 1.5rem; font-weight: 700; color: var(--primary); }
        .schedule-weekday { font-size: 0.75rem; color: var(--text-light); }
        .schedule-info { flex: 1; min-width: 0; }
        
        .schedule-title-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 8px;
        }
        
        .schedule-title { 
            font-weight: 500; 
            margin-bottom: 4px; 
            flex: 1;
            white-space: pre-wrap;
            word-break: break-word;
        }
        .schedule-time { font-size: 0.85rem; color: var(--text-secondary); }

        .schedule-item-btns {
            display: flex;
            gap: 4px;
            flex-shrink: 0;
        }

        .schedule-item-btns button {
            width: 28px;
            height: 28px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            background: white;
        }

        .schedule-item-btns .edit-btn:hover {
            background: var(--primary-light);
        }

        .schedule-item-btns .delete-btn:hover {
            background: #ffebee;
        }

        .schedule-search {
            margin-bottom: 12px;
        }

        .schedule-search .form-input {
            background: var(--bg-warm);
            border: 1px solid var(--border);
        }

        .auto-link {
            color: var(--primary);
            text-decoration: underline;
            word-break: break-all;
        }

        .auto-link:hover {
            color: var(--accent);
        }

        .dept-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .dept-manage-btn {
            padding: 6px 12px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 16px;
            font-size: 0.8rem;
            cursor: pointer;
            font-family: inherit;
        }

        .dept-tabs {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding-bottom: 12px;
            margin-bottom: 16px;
            border-bottom: 1px solid var(--border);
            flex-wrap: wrap;
        }

        .dept-tab {
            flex-shrink: 0;
            padding: 8px 16px;
            background: var(--bg-warm);
            border: none;
            border-radius: 20px;
            font-family: inherit;
            font-size: 0.9rem;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .dept-tab.active { background: var(--primary); color: white; }

        .dept-post {
            background: var(--bg-warm);
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 12px;
            cursor: pointer;
        }

        .dept-post.locked { border: 2px solid var(--accent); }

        .dept-post-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .dept-post-title { font-weight: 600; color: var(--primary); display: flex; align-items: center; gap: 6px; }
        .dept-post-date { font-size: 0.8rem; color: var(--text-light); }
        .dept-post-preview { font-size: 0.9rem; color: var(--text-secondary); }

        .lock-icon { color: var(--accent); }

        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 0.9rem; font-weight: 500; margin-bottom: 8px; }

        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 10px;
            font-family: inherit;
            font-size: 1rem;
            background: white;
        }

        .form-textarea { min-height: 100px; resize: vertical; }

        .form-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px;
            background: var(--bg-warm);
            border-radius: 10px;
            cursor: pointer;
        }

        .form-checkbox input { width: 18px; height: 18px; }

        .password-field {
            display: none;
            margin-top: 12px;
            padding: 12px;
            background: #fff8e6;
            border-radius: 10px;
            border: 1px solid var(--accent);
        }

        .password-field.active { display: block; }

        .password-field label {
            display: block;
            font-size: 0.85rem;
            color: var(--accent);
            margin-bottom: 8px;
            font-weight: 500;
        }

        .password-field input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-family: inherit;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
        }

        .btn-primary { background: var(--primary); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-block { width: 100%; }
        .btn-group { display: flex; gap: 8px; }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
            box-shadow: 0 -2px 20px var(--shadow);
            border-top: 1px solid var(--border);
            z-index: 100;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 12px;
            color: var(--text-light);
            cursor: pointer;
            background: none;
            border: none;
            font-family: inherit;
        }

        .nav-item.active { color: var(--primary); }
        .nav-icon { font-size: 1.4rem; }
        .nav-text { font-size: 0.65rem; font-weight: 500; }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 200;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.active { display: flex; }

        .modal {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 500px;
            max-height: 85vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: white;
        }

        .modal-title {
            font-family: 'Nanum Myeongjo', serif;
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary);
        }

        .modal-close {
            background: var(--danger);
            border: none;
            font-size: 1.2rem;
            color: white;
            cursor: pointer;
            padding: 8px 14px;
            border-radius: 8px;
        }

        .modal-body { padding: 20px; }

        .delete-btn {
            background: none;
            border: none;
            color: var(--danger);
            cursor: pointer;
            padding: 4px;
            font-size: 1rem;
            opacity: 0.6;
        }

        .delete-btn:hover { opacity: 1; }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-light);
        }

        .empty-state .icon { font-size: 3rem; margin-bottom: 12px; }

        .icon-picker {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 6px;
            margin-top: 8px;
            max-height: 200px;
            overflow-y: auto;
            padding: 4px;
        }

        .icon-option {
            padding: 8px;
            font-size: 1.3rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            background: white;
        }

        .icon-option:hover { border-color: var(--primary); }
        .icon-option.selected { background: var(--primary); border-color: var(--primary); }

        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary-dark);
            color: white;
            padding: 12px 24px;
            border-radius: 30px;
            font-size: 0.9rem;
            z-index: 300;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .toast.show { opacity: 1; }

        .comments-section {
            margin-top: 20px;
            border-top: 1px solid var(--border);
            padding-top: 16px;
        }

        .comments-title {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 12px;
        }

        .comment-item {
            background: var(--bg-warm);
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 8px;
            position: relative;
        }

        .comment-header { display: flex; justify-content: space-between; margin-bottom: 6px; }
        .comment-author { font-size: 0.85rem; font-weight: 500; color: var(--primary); }
        .comment-date { font-size: 0.75rem; color: var(--text-light); }
        .comment-content { font-size: 0.9rem; line-height: 1.5; }

        .comment-delete {
            position: absolute;
            top: 8px;
            right: 8px;
            background: none;
            border: none;
            color: var(--danger);
            cursor: pointer;
            opacity: 0.5;
        }

        .comment-form {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .comment-form input[type="text"]:first-child { width: 80px; flex-shrink: 0; }

        .comment-form input {
            flex: 1;
            padding: 10px 14px;
            border: 1px solid var(--border);
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .comment-form button {
            padding: 10px 16px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
        }

        .selected-schedule-item {
            padding: 12px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-warm);
            border-radius: 8px;
            margin-bottom: 8px;
            position: relative;
        }

        .selected-schedule-item:last-child {
            margin-bottom: 0;
        }

        .schedule-actions {
            display: flex;
            justify-content: flex-end;
            gap: 6px;
            margin-bottom: 8px;
        }

        .schedule-actions button {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .schedule-actions button:hover {
            transform: scale(1.1);
        }

        .schedule-actions .edit-btn:hover {
            background: var(--primary-light);
        }

        .schedule-actions .delete-btn:hover {
            background: #ffebee;
        }

        .schedule-title {
            font-weight: 500;
            margin-bottom: 4px;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .schedule-time {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .auto-resize {
            min-height: 60px;
            max-height: 200px;
            resize: none;
            overflow-y: auto;
        }

        .mt-16 { margin-top: 16px; }
        .mb-16 { margin-bottom: 16px; }

        .password-prompt { text-align: center; padding: 20px; }
        .password-prompt .lock-big { font-size: 3rem; margin-bottom: 16px; }
        .password-prompt p { color: var(--text-secondary); margin-bottom: 16px; }

        .password-prompt input {
            width: 100%;
            max-width: 200px;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 1.1rem;
            text-align: center;
            margin-bottom: 16px;
        }

        .password-error { color: var(--danger); font-size: 0.9rem; margin-bottom: 12px; display: none; }
        .password-error.show { display: block; }

        .quick-add-btn {
            width: 100%;
            padding: 12px;
            margin-top: 12px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.9rem;
            cursor: pointer;
        }

        .dept-manage-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: var(--bg-warm);
            border-radius: 10px;
            margin-bottom: 8px;
        }

        .dept-manage-info { display: flex; align-items: center; gap: 10px; }
        .dept-manage-icon { font-size: 1.5rem; }
        .dept-manage-name { font-weight: 500; }
        .dept-manage-actions { display: flex; gap: 8px; }

        .dept-manage-actions button {
            padding: 6px 10px;
            border: none;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
        }

        .dept-edit-btn { background: var(--primary); color: white; }
        .dept-delete-btn { background: var(--danger); color: white; }

        .admin-panel {
            display: none;
            background: var(--bg-card);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            border: 2px solid var(--accent);
        }

        .admin-panel.show { display: block; }

        .admin-title { font-size: 0.9rem; font-weight: 700; color: var(--accent); margin-bottom: 12px; }

        .admin-toggle-btn {
            display: block;
            width: 100%;
            padding: 10px;
            margin-bottom: 12px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.9rem;
            cursor: pointer;
        }

        .calendar-legend {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            margin-top: 12px;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .legend-item { display: flex; align-items: center; gap: 4px; }
        .legend-dot { width: 8px; height: 8px; border-radius: 50%; }
        .legend-dot.event { background: #e74c3c; }
        .legend-dot.today { background: var(--primary); }

        .verse-manage-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            font-size: 1rem;
            cursor: pointer;
            color: white;
        }

        .verse-manage-btn:hover { background: rgba(255,255,255,0.3); }

        .verse-input-group {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            align-items: center;
        }

        .verse-day {
            min-width: 40px;
            font-weight: 700;
            color: var(--primary);
            text-align: center;
        }

        .verse-input-group input {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .verse-input-group input:first-of-type { flex: 2; }

        .verse-list-container {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 8px;
        }

        .verse-quick-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .verse-quick-actions button {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-warm);
            cursor: pointer;
            font-size: 0.85rem;
        }

        .verse-quick-actions button:hover { background: var(--border); }

        .verse-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .verse-tab {
            flex: 1;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-warm);
            cursor: pointer;
            font-size: 0.9rem;
            font-family: inherit;
        }

        .verse-tab.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .verse-tab-content {
            display: none;
        }

        .verse-tab-content.active {
            display: block;
        }

        .upload-area {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 16px;
        }

        .upload-area:hover {
            border-color: var(--primary);
            background: var(--bg-warm);
        }

        .upload-area .upload-icon {
            font-size: 3rem;
            margin-bottom: 12px;
        }

        .divider-text {
            text-align: center;
            color: var(--text-light);
            margin: 16px 0;
            position: relative;
        }

        .divider-text::before,
        .divider-text::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 40%;
            height: 1px;
            background: var(--border);
        }

        .divider-text::before { left: 0; }
        .divider-text::after { right: 0; }

        .parse-result {
            background: var(--bg-warm);
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
            font-size: 0.9rem;
        }

        .parse-result.success { border-left: 4px solid var(--success); }
        .parse-result.error { border-left: 4px solid var(--danger); }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="connection-status">
                <span class="status-dot" id="statusDot"></span>
                <span id="statusText">Ïó∞Í≤∞ Ï§ë...</span>
            </div>
            <h1 class="church-name">ÏÑúÏÑúÏö∏ÏÑ±ÏÑúÏπ®Î°ÄÍµêÌöå</h1>
            <p class="church-subtitle">West Seoul Bible Baptist Church</p>
        </div>
    </header>

    <main class="main-content">
        <section id="home" class="section active">
            <div class="card welcome-card" style="position:relative;">
                <button class="verse-manage-btn" onclick="openVerseModal()">‚öôÔ∏è</button>
                <h2 class="card-title">‚úùÔ∏è Ïò§ÎäòÏùò ÎßêÏîÄ</h2>
                <p class="daily-verse" id="dailyVerse">"Ìï≠ÏÉÅ Í∏∞ÎªêÌïòÎùº Ïâ¨ÏßÄ ÎßêÍ≥† Í∏∞ÎèÑÌïòÎùº Î≤îÏÇ¨Ïóê Í∞êÏÇ¨ÌïòÎùº"</p>
                <p class="verse-reference" id="verseReference">Îç∞ÏÇ¥Î°úÎãàÍ∞ÄÏ†ÑÏÑú 5:16-18</p>
            </div>
            <div class="card">
                <div class="card-header-with-btn">
                    <h3 class="card-title">‚≠ê Ï¶êÍ≤®Ï∞æÍ∏∞</h3>
                    <button class="card-manage-btn" onclick="openLinkManageModal()">‚öôÔ∏è Í¥ÄÎ¶¨</button>
                </div>
                <div class="quick-links" id="quickLinks"></div>
            </div>
            <div class="card">
                <h3 class="card-title">üì¢ ÏµúÍ∑º Í≥µÏßÄ</h3>
                <div id="recentNotices"></div>
            </div>
        </section>

        <section id="notice" class="section">
            <div class="card">
                <h3 class="card-title">üì¢ Í≥µÏßÄÏÇ¨Ìï≠</h3>
                <button class="admin-toggle-btn" onclick="togglePanel('noticeAdminPanel', this)">‚ûï Í≥µÏßÄ Îì±Î°ùÌïòÍ∏∞</button>
                <div class="admin-panel" id="noticeAdminPanel">
                    <h4 class="admin-title">‚öôÔ∏è Í≥µÏßÄ Îì±Î°ù</h4>
                    <div class="form-group">
                        <label class="form-label">Ï†úÎ™©</label>
                        <input type="text" class="form-input" id="noticeTitle" placeholder="Í≥µÏßÄ Ï†úÎ™©">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ÎÇ¥Ïö©</label>
                        <textarea class="form-textarea" id="noticeContent" placeholder="Í≥µÏßÄ ÎÇ¥Ïö©"></textarea>
                    </div>
                    <div class="form-group">
                        <label><input type="checkbox" id="noticeImportant"> Ï§ëÏöî Í≥µÏßÄ</label>
                    </div>
                    <button class="btn btn-primary btn-block" onclick="addNotice()">Í≥µÏßÄ Îì±Î°ù</button>
                </div>
                <div id="noticeList"></div>
            </div>
        </section>

        <section id="prayer" class="section">
            <div class="card">
                <h3 class="card-title">üôè Í∏∞ÎèÑÏ†úÎ™©</h3>
                <div class="month-selector">
                    <button class="month-btn" onclick="changeMonth(-1)">‚Äπ</button>
                    <span class="current-month" id="currentMonth"></span>
                    <button class="month-btn" onclick="changeMonth(1)">‚Ä∫</button>
                </div>
                <button class="btn btn-primary btn-block mb-16" onclick="openPrayerModal()">‚úèÔ∏è Í∏∞ÎèÑÏ†úÎ™© Ïò¨Î¶¨Í∏∞</button>
                <div id="prayerList"></div>
            </div>
        </section>

        <section id="thanks" class="section">
            <div class="card">
                <h3 class="card-title">üíù Í∞êÏÇ¨Ï†úÎ™©</h3>
                <div class="month-selector">
                    <button class="month-btn" onclick="changeThanksMonth(-1)">‚Äπ</button>
                    <span class="current-month" id="currentThanksMonth"></span>
                    <button class="month-btn" onclick="changeThanksMonth(1)">‚Ä∫</button>
                </div>
                <button class="btn btn-primary btn-block mb-16" onclick="openThanksModal()">‚úèÔ∏è Í∞êÏÇ¨Ï†úÎ™© Ïò¨Î¶¨Í∏∞</button>
                <div id="thanksList"></div>
            </div>
        </section>

        <section id="schedule" class="section">
            <div class="card">
                <div class="calendar-header">
                    <button class="month-btn" onclick="changeCalendarMonth(-1)">‚Äπ</button>
                    <span class="current-month" id="calendarMonth"></span>
                    <button class="month-btn" onclick="changeCalendarMonth(1)">‚Ä∫</button>
                </div>
                <div class="calendar-grid" id="calendarGrid"></div>
                <div class="calendar-legend">
                    <div class="legend-item"><span class="legend-dot today"></span> Ïò§Îäò</div>
                    <div class="legend-item"><span class="legend-dot event"></span> ÏùºÏ†ï ÏûàÏùå</div>
                </div>
                <div class="selected-date-info" id="selectedDateInfo" style="display:none;">
                    <div class="selected-date-title" id="selectedDateTitle"></div>
                    <div id="selectedDateSchedules"></div>
                    <button class="quick-add-btn" onclick="openQuickScheduleModal()">‚ûï Ïù¥ ÎÇ†ÏßúÏóê ÏùºÏ†ï Ï∂îÍ∞Ä</button>
                </div>
                <h4 class="card-title mt-16">üìã Ïù¥Î≤à Îã¨ ÏùºÏ†ï</h4>
                <div class="schedule-search">
                    <input type="text" class="form-input" id="scheduleSearchInput" placeholder="üîç ÏùºÏ†ï Í≤ÄÏÉâ..." oninput="searchSchedules()">
                </div>
                <div id="monthSchedules"></div>
            </div>
        </section>

        <section id="department" class="section">
            <div class="card">
                <div class="dept-header">
                    <h3 class="card-title" style="margin-bottom:0;">üë• Î∂ÄÏÑú Í≤åÏãúÌåê</h3>
                    <button class="dept-manage-btn" onclick="openDeptManageModal()">‚öôÔ∏è Î∂ÄÏÑú Í¥ÄÎ¶¨</button>
                </div>
                <div class="dept-tabs" id="deptTabs"></div>
                <button class="admin-toggle-btn" onclick="togglePanel('deptAdminPanel', this)">‚ûï Í≤åÏãúÍ∏Ä Îì±Î°ùÌïòÍ∏∞</button>
                <div class="admin-panel" id="deptAdminPanel">
                    <h4 class="admin-title">‚öôÔ∏è Í≤åÏãúÍ∏Ä Îì±Î°ù</h4>
                    <div class="form-group">
                        <label class="form-label">Î∂ÄÏÑú</label>
                        <select class="form-select" id="deptPostDept"></select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ï†úÎ™©</label>
                        <input type="text" class="form-input" id="deptPostTitle" placeholder="Ï†úÎ™©">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ÎÇ¥Ïö©</label>
                        <textarea class="form-textarea" id="deptPostContent" placeholder="ÎÇ¥Ïö©"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-checkbox">
                            <input type="checkbox" id="deptPostLocked" onchange="togglePasswordField()">
                            <span>üîí ÎπÑÎ∞ÄÍ∏ÄÎ°ú ÏÑ§Ï†ï</span>
                        </label>
                        <div class="password-field" id="passwordField">
                            <label>ÎπÑÎ∞ÄÎ≤àÌò∏ ÏÑ§Ï†ï</label>
                            <input type="text" id="deptPostPassword" placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏ ÏûÖÎ†•">
                        </div>
                    </div>
                    <button class="btn btn-primary btn-block" onclick="addDeptPost()">Í≤åÏãúÍ∏Ä Îì±Î°ù</button>
                </div>
                <div id="deptContents"></div>
            </div>
        </section>
    </main>

    <nav class="bottom-nav">
        <button class="nav-item" onclick="showSection('notice', this)"><span class="nav-icon">üì¢</span><span class="nav-text">Í≥µÏßÄ</span></button>
        <button class="nav-item" onclick="showSection('schedule', this)"><span class="nav-icon">üìÖ</span><span class="nav-text">ÏùºÏ†ï</span></button>
        <button class="nav-item active" onclick="showSection('home', this)"><span class="nav-icon">üè†</span><span class="nav-text">Ìôà</span></button>
        <button class="nav-item" onclick="showSection('prayer', this)"><span class="nav-icon">üôè</span><span class="nav-text">Í∏∞ÎèÑ</span></button>
        <button class="nav-item" onclick="showSection('thanks', this)"><span class="nav-icon">üíù</span><span class="nav-text">Í∞êÏÇ¨</span></button>
        <button class="nav-item" onclick="showSection('department', this)"><span class="nav-icon">üë•</span><span class="nav-text">Î∂ÄÏÑú</span></button>
    </nav>

    <!-- Î™®Îã¨Îì§ -->
    <div class="modal-overlay" id="prayerModal" onclick="if(event.target===this)closeModal('prayerModal')">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="prayerModalTitle">Í∏∞ÎèÑÏ†úÎ™© Ïò¨Î¶¨Í∏∞</h3>
                <button class="modal-close" onclick="closeModal('prayerModal')">‚úï</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="prayerEditId">
                <div class="form-group">
                    <label class="form-label">Ïù¥Î¶Ñ</label>
                    <input type="text" class="form-input" id="prayerAuthor" placeholder="ÏùµÎ™Ö Í∞ÄÎä•">
                </div>
                <div class="form-group">
                    <label class="form-label">Í∏∞ÎèÑÏ†úÎ™©</label>
                    <textarea class="form-textarea" id="prayerContent" placeholder="Í∏∞ÎèÑÏ†úÎ™©ÏùÑ ÎÇòÎà†Ï£ºÏÑ∏Ïöî"></textarea>
                </div>
                <button class="btn btn-primary btn-block" onclick="savePrayer()">Îì±Î°ùÌïòÍ∏∞</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="thanksModal" onclick="if(event.target===this)closeModal('thanksModal')">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="thanksModalTitle">Í∞êÏÇ¨Ï†úÎ™© Ïò¨Î¶¨Í∏∞</h3>
                <button class="modal-close" onclick="closeModal('thanksModal')">‚úï</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="thanksEditId">
                <div class="form-group">
                    <label class="form-label">Ïù¥Î¶Ñ</label>
                    <input type="text" class="form-input" id="thanksAuthor" placeholder="ÏùµÎ™Ö Í∞ÄÎä•">
                </div>
                <div class="form-group">
                    <label class="form-label">Í∞êÏÇ¨Ï†úÎ™©</label>
                    <textarea class="form-textarea" id="thanksContent" placeholder="Í∞êÏÇ¨Ìïú ÏùºÏùÑ ÎÇòÎà†Ï£ºÏÑ∏Ïöî"></textarea>
                </div>
                <button class="btn btn-primary btn-block" onclick="saveThanks()">Îì±Î°ùÌïòÍ∏∞</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="noticeModal" onclick="if(event.target===this)closeModal('noticeModal')">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="noticeModalTitle"></h3>
                <button class="modal-close" onclick="closeModal('noticeModal')">‚úï</button>
            </div>
            <div class="modal-body">
                <p class="notice-date mb-16" id="noticeModalDate"></p>
                <div id="noticeModalContent" style="line-height: 1.8; white-space: pre-wrap;"></div>
                <div class="comments-section">
                    <h4 class="comments-title">üí¨ ÎåìÍ∏Ä <span id="commentCount"></span></h4>
                    <div id="noticeComments"></div>
                    <div class="comment-form">
                        <input type="text" id="commentAuthor" placeholder="Ïù¥Î¶Ñ">
                        <input type="text" id="commentContent" placeholder="ÎåìÍ∏Ä ÏûÖÎ†•">
                        <button onclick="addComment()">Îì±Î°ù</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="linkModal" onclick="if(event.target===this)closeModal('linkModal')">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="linkModalTitle">Ï¶êÍ≤®Ï∞æÍ∏∞ Ï∂îÍ∞Ä</h3>
                <button class="modal-close" onclick="closeModal('linkModal')">‚úï</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="linkEditId">
                <div class="form-group">
                    <label class="form-label">Ïù¥Î¶Ñ</label>
                    <input type="text" class="form-input" id="linkName" placeholder="Ïòà: ÍµêÌöå Ïπ¥Ìéò">
                </div>
                <div class="form-group">
                    <label class="form-label">URL</label>
                    <input type="url" class="form-input" id="linkUrl" placeholder="https://...">
                </div>
                <div class="form-group">
                    <label class="form-label">ÏïÑÏù¥ÏΩò ÏÑ†ÌÉù</label>
                    <div class="icon-picker" id="iconPicker"></div>
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" style="flex:1" onclick="saveLink()">Ï†ÄÏû•</button>
                    <button class="btn btn-danger" id="deleteLinkBtn" style="display:none" onclick="deleteLink()">ÏÇ≠Ï†ú</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="linkOrderModal" onclick="if(event.target===this)closeModal('linkOrderModal')">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">‚öôÔ∏è Ï¶êÍ≤®Ï∞æÍ∏∞ Í¥ÄÎ¶¨</h3>
                <button class="modal-close" onclick="closeModal('linkOrderModal')">‚úï</button>
            </div>
            <div class="modal-body">
                <button class="btn btn-primary btn-block mb-16" onclick="closeModal('linkOrderModal');openLinkModal();">‚ûï ÏÉà Ï¶êÍ≤®Ï∞æÍ∏∞ Ï∂îÍ∞Ä</button>
                <p style="font-size:0.85rem; color:var(--text-secondary); margin-bottom:12px; text-align:center;">
                    ‚ò∞ ÎìúÎûòÍ∑∏ÌïòÏó¨ ÏàúÏÑú Î≥ÄÍ≤Ω
                </p>
                <div id="linkOrderList" class="link-order-list"></div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="deptManageModal" onclick="if(event.target===this)closeModal('deptManageModal')">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">‚öôÔ∏è Î∂ÄÏÑú Í¥ÄÎ¶¨</h3>
                <button class="modal-close" onclick="closeModal('deptManageModal')">‚úï</button>
            </div>
            <div class="modal-body">
                <button class="btn btn-primary btn-block mb-16" onclick="openDeptAddModal()">‚ûï ÏÉà Î∂ÄÏÑú Ï∂îÍ∞Ä</button>
                <div id="deptManageList"></div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="deptModal" onclick="if(event.target===this)closeModal('deptModal')">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="deptModalTitle">Î∂ÄÏÑú Ï∂îÍ∞Ä</h3>
                <button class="modal-close" onclick="closeModal('deptModal')">‚úï</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="deptEditId">
                <div class="form-group">
                    <label class="form-label">Î∂ÄÏÑú Ïù¥Î¶Ñ</label>
                    <input type="text" class="form-input" id="deptName" placeholder="Ïòà: Ï≤≠ÎÖÑÎ∂Ä">
                </div>
                <div class="form-group">
                    <label class="form-label">ÏïÑÏù¥ÏΩò ÏÑ†ÌÉù</label>
                    <div class="icon-picker" id="deptIconPicker"></div>
                </div>
                <button class="btn btn-primary btn-block" onclick="saveDept()">Ï†ÄÏû•</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="deptPostModal" onclick="if(event.target===this)closeModal('deptPostModal')">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="deptPostModalTitle"></h3>
                <button class="modal-close" onclick="closeModal('deptPostModal')">‚úï</button>
            </div>
            <div class="modal-body" id="deptPostModalBody"></div>
        </div>
    </div>

    <div class="modal-overlay" id="passwordModal" onclick="if(event.target===this)closeModal('passwordModal')">
        <div class="modal" style="max-width: 350px;">
            <div class="modal-header">
                <h3 class="modal-title">üîí ÎπÑÎ∞ÄÍ∏Ä</h3>
                <button class="modal-close" onclick="closeModal('passwordModal')">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="password-prompt">
                    <div class="lock-big">üîê</div>
                    <p>ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÌïÑÏöîÌï©ÎãàÎã§</p>
                    <input type="password" id="passwordInput" placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏" onkeypress="if(event.key==='Enter')checkPassword()">
                    <p class="password-error" id="passwordError">ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÌãÄÎ†∏ÏäµÎãàÎã§</p>
                    <button class="btn btn-primary btn-block" onclick="checkPassword()">ÌôïÏù∏</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="quickScheduleModal" onclick="if(event.target===this)closeModal('quickScheduleModal')">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h3 class="modal-title" id="quickScheduleTitle">üìÖ ÏùºÏ†ï Îì±Î°ù</h3>
                <button class="modal-close" onclick="closeModal('quickScheduleModal')">‚úï</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="scheduleEditId">
                <div class="form-group" id="scheduleDateGroup" style="display:none;">
                    <label class="form-label">üìÜ ÎÇ†Ïßú</label>
                    <input type="date" class="form-input" id="quickScheduleDate">
                </div>
                <div class="form-group">
                    <label class="form-label">Ï†úÎ™©</label>
                    <textarea class="form-input auto-resize" id="quickScheduleInput" placeholder="ÏùºÏ†ï ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî" rows="2" oninput="autoResize(this)"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">ÏãúÍ∞Ñ (ÏÑ†ÌÉù)</label>
                    <input type="text" class="form-input" id="quickScheduleTime" placeholder="Ïòà: Ïò§Ï†Ñ 11Ïãú">
                </div>
                <button class="btn btn-primary btn-block" id="scheduleSubmitBtn" onclick="saveQuickSchedule()">Îì±Î°ù</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="verseModal" onclick="if(event.target===this)closeModal('verseModal')">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">üìñ Ïò§ÎäòÏùò ÎßêÏîÄ Í¥ÄÎ¶¨</h3>
                <button class="modal-close" onclick="closeModal('verseModal')">‚úï</button>
            </div>
            <div class="modal-body">
                <!-- ÌÉ≠ Î©îÎâ¥ -->
                <div class="verse-tabs">
                    <button class="verse-tab active" onclick="switchVerseTab('upload')">üìÅ ÌååÏùº/ÌÖçÏä§Ìä∏ ÏóÖÎ°úÎìú</button>
                    <button class="verse-tab" onclick="switchVerseTab('manual')">‚úèÔ∏è ÏßÅÏ†ë ÏûÖÎ†•</button>
                </div>

                <!-- ÏóÖÎ°úÎìú ÌÉ≠ -->
                <div id="verseUploadTab" class="verse-tab-content active">
                    <p style="color:var(--text-secondary); margin-bottom: 16px; font-size: 0.9rem;">
                        üìå Word ÌååÏùº(.docx), ÌÖçÏä§Ìä∏ ÌååÏùº(.txt)ÏùÑ ÏóÖÎ°úÎìúÌïòÍ±∞ÎÇò ÌÖçÏä§Ìä∏Î•º ÏßÅÏ†ë Î∂ôÏó¨ÎÑ£ÏúºÏÑ∏Ïöî.
                    </p>
                    
                    <div class="upload-area" onclick="document.getElementById('verseFileInput').click()">
                        <input type="file" id="verseFileInput" accept=".docx,.txt" style="display:none" onchange="handleVerseFile(this)">
                        <div class="upload-icon">üìÑ</div>
                        <p>ÌååÏùºÏùÑ ÏÑ†ÌÉùÌïòÍ±∞ÎÇò Ïó¨Í∏∞Ïóê ÎìúÎûòÍ∑∏ÌïòÏÑ∏Ïöî</p>
                        <p style="font-size:0.8rem; color:var(--text-light)">.docx, .txt ÌååÏùº ÏßÄÏõê</p>
                    </div>

                    <div class="divider-text">ÎòêÎäî ÌÖçÏä§Ìä∏ Î∂ôÏó¨ÎÑ£Í∏∞</div>

                    <textarea id="verseTextArea" class="form-textarea" style="min-height:200px;" placeholder="ÏòàÏãú:
1Ïõî 1Ïùº Î™©ÏöîÏùº
ÏãúÌé∏ 90:12 Ïö∞Î¶¨ÏóêÍ≤å Ïö∞Î¶¨ ÎÇ† Í≥ÑÏàòÌï®ÏùÑ Í∞ÄÎ•¥ÏπòÏÇ¨ ÏßÄÌòúÎ°úÏö¥ ÎßàÏùåÏùÑ ÏñªÍ≤å ÌïòÏÜåÏÑú
1Ïõî 2Ïùº Í∏àÏöîÏùº
ÎßàÌÉúÎ≥µÏùå 6:33 Í∑∏Îü∞Ï¶â ÎÑàÌù¨Îäî Î®ºÏ†Ä Í∑∏Ïùò ÎÇòÎùºÏôÄ Í∑∏Ïùò ÏùòÎ•º Íµ¨ÌïòÎùº..."></textarea>
                    
                    <button class="btn btn-primary btn-block mt-16" onclick="parseAndSaveVerses()">üì• ÎßêÏîÄ Î∂àÎü¨Ïò§Í∏∞</button>
                </div>

                <!-- ÏßÅÏ†ë ÏûÖÎ†• ÌÉ≠ -->
                <div id="verseManualTab" class="verse-tab-content">
                    <div class="verse-quick-actions">
                        <button onclick="clearAllVerses()">üóëÔ∏è Ï†ÑÏ≤¥ ÏÇ≠Ï†ú</button>
                        <button onclick="loadSampleVerses()">üìù ÏÉòÌîå Î∂àÎü¨Ïò§Í∏∞</button>
                    </div>
                    <div class="verse-list-container" id="verseListContainer"></div>
                    <button class="btn btn-primary btn-block mt-16" onclick="saveAllVerses()">üíæ Ï†ÄÏû•ÌïòÍ∏∞</button>
                </div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // ========== Ï†ÑÏó≠ Î≥ÄÏàò ==========
        var db = null;
        var currentPrayerMonth = new Date();
        var currentCalendarMonth = new Date();
        var selectedDate = null;
        var currentDept = null;
        var selectedIcon = 'üîó';
        var selectedDeptIcon = 'üëî';
        var currentNoticeId = null;
        var pendingPost = null;

        var notices = [];
        var prayers = [];
        var thanks = [];
        var schedules = [];
        var links = [];
        var departments = [];
        var deptPosts = {};
        var comments = {};
        var dailyVerses = {};
        var currentThanksMonth = new Date();

        var linkIcons = ['‚úùÔ∏è', '‚õ™', 'üôè', 'üìñ', 'üïäÔ∏è', 'üëº', 'üîî', 'üïØÔ∏è', 'üíí', '‚ú®', 'üåü', '‚ù§Ô∏è', 'üíù', 'ü§ù', 'üåà', 'üåæ', 'üçû', 'üêë', 'üêü', '‚≠ê', 'üåÖ', 'üí°', 'üõê', 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶', 'üôå', 'üì∫', 'üéµ', 'üé¨', 'üì∑', 'üéß', 'üí¨', 'üìß', '‚òéÔ∏è', 'üíå', 'üåê', '‚òï', 'üçΩÔ∏è', 'üõí', 'üí∞', 'üéÅ', 'üè†', 'üè¢', 'üìç', 'üöó', '‚úàÔ∏è', 'üì±', 'üíª', 'üîç', 'üìù', '‚úèÔ∏è', 'üìö', 'üóÇÔ∏è', '‚öôÔ∏è', 'üéØ', 'üîó'];
        var deptIcons = ['üëî', 'üëó', 'üåü', 'üéì', 'üßí', 'üéµ', 'üìö', 'üé∫', 'üéπ', 'üë®‚Äçüë©‚Äçüëß', 'üë¥', 'üëµ', 'üíí', '‚úùÔ∏è', 'üìñ', 'üôè'];

        var verses = [
            { text: "Ìï≠ÏÉÅ Í∏∞ÎªêÌïòÎùº Ïâ¨ÏßÄ ÎßêÍ≥† Í∏∞ÎèÑÌïòÎùº Î≤îÏÇ¨Ïóê Í∞êÏÇ¨ÌïòÎùº", reference: "Îç∞ÏÇ¥Î°úÎãàÍ∞ÄÏ†ÑÏÑú 5:16-18" },
            { text: "Ïó¨Ìò∏ÏôÄÎäî ÎÇòÏùò Î™©ÏûêÏãúÎãà ÎÇ¥Í≤å Î∂ÄÏ°±Ìï®Ïù¥ ÏóÜÏúºÎ¶¨Î°úÎã§", reference: "ÏãúÌé∏ 23:1" },
            { text: "ÎëêÎ†§ÏõåÌïòÏßÄ ÎßêÎùº ÎÇ¥Í∞Ä ÎÑàÏôÄ Ìï®Íªò Ìï®Ïù¥Îùº", reference: "Ïù¥ÏÇ¨Ïïº 41:10" }
        ];

        // ========== Firebase Ï¥àÍ∏∞Ìôî ==========
        var firebaseConfig = {
            apiKey: "AIzaSyA7zoDte4aKn8IJXpkmYYSL9hHWlrQlp-c",
            authDomain: "church-app-cce2f.firebaseapp.com",
            databaseURL: "https://church-app-cce2f-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "church-app-cce2f"
        };

        // Firebase Ï¶âÏãú Ï¥àÍ∏∞Ìôî
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();
            console.log('Firebase Ï¥àÍ∏∞Ìôî ÏÑ±Í≥µ');
        } catch(e) {
            console.error('Firebase Ï¥àÍ∏∞Ìôî Ïã§Ìå®:', e);
        }

        // ========== ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ïã§Ìñâ ==========
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Î°úÎìú ÏôÑÎ£å');
            
            if (db) {
                // Ïó∞Í≤∞ ÏÉÅÌÉú ÌôïÏù∏
                db.ref('.info/connected').on('value', function(snap) {
                    var connected = snap.val() === true;
                    document.getElementById('statusDot').className = 'status-dot' + (connected ? ' connected' : '');
                    document.getElementById('statusText').textContent = connected ? 'Ïã§ÏãúÍ∞Ñ Ïó∞Í≤∞Îê®' : 'Ïò§ÌîÑÎùºÏù∏';
                });

                // Îç∞Ïù¥ÌÑ∞ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï
                setupListeners();
            } else {
                document.getElementById('statusText').textContent = 'Ïó∞Í≤∞ Ïã§Ìå®';
            }

            // UI Ï¥àÍ∏∞Ìôî
            initIconPickers();
            setDailyVerse();
        });

        // ========== Îç∞Ïù¥ÌÑ∞ Î¶¨Ïä§ÎÑà ==========
        function setupListeners() {
            // Í≥µÏßÄ
            db.ref('notices').on('value', function(snap) {
                notices = [];
                snap.forEach(function(c) { notices.unshift({ id: c.key, ...c.val() }); });
                renderNotices();
                renderRecentNotices();
            });

            // Í∏∞ÎèÑÏ†úÎ™©
            db.ref('prayers').on('value', function(snap) {
                prayers = [];
                snap.forEach(function(c) { prayers.unshift({ id: c.key, ...c.val() }); });
                renderPrayers();
            });

            // Í∞êÏÇ¨Ï†úÎ™©
            db.ref('thanks').on('value', function(snap) {
                thanks = [];
                snap.forEach(function(c) { thanks.unshift({ id: c.key, ...c.val() }); });
                renderThanks();
            });

            // ÏùºÏ†ï
            db.ref('schedules').on('value', function(snap) {
                schedules = [];
                snap.forEach(function(c) { schedules.push({ id: c.key, ...c.val() }); });
                console.log('ÏùºÏ†ï Î°úÎìú:', schedules.length);
                renderCalendar();
                renderSchedules();
                if (selectedDate) showSelectedDateSchedules();
            });

            // Ï¶êÍ≤®Ï∞æÍ∏∞
            db.ref('links').on('value', function(snap) {
                links = [];
                snap.forEach(function(c) { links.push({ id: c.key, ...c.val() }); });
                console.log('Ï¶êÍ≤®Ï∞æÍ∏∞ Î°úÎìú:', links.length);
                renderQuickLinks();
            });

            // Î∂ÄÏÑú
            db.ref('departments').on('value', function(snap) {
                departments = [];
                snap.forEach(function(c) { departments.push({ id: c.key, ...c.val() }); });
                departments.sort(function(a, b) { return (a.order || 0) - (b.order || 0); });
                console.log('Î∂ÄÏÑú Î°úÎìú:', departments.length, departments);
                
                if (departments.length > 0 && (!currentDept || !departments.find(function(d) { return d.id === currentDept; }))) {
                    currentDept = departments[0].id;
                }
                if (departments.length === 0) currentDept = null;
                
                renderDeptTabs();
                updateDeptSelect();
                renderDeptPosts();
            });

            // Î∂ÄÏÑú Í≤åÏãúÍ∏Ä
            db.ref('deptPosts').on('value', function(snap) {
                deptPosts = {};
                snap.forEach(function(dept) {
                    deptPosts[dept.key] = [];
                    dept.forEach(function(post) {
                        deptPosts[dept.key].unshift({ id: post.key, ...post.val() });
                    });
                });
                renderDeptPosts();
            });

            // ÎåìÍ∏Ä
            db.ref('comments').on('value', function(snap) {
                comments = {};
                snap.forEach(function(c) {
                    comments[c.key] = [];
                    c.forEach(function(comment) {
                        comments[c.key].push({ id: comment.key, ...comment.val() });
                    });
                });
                if (currentNoticeId) renderComments(currentNoticeId);
            });

            // Ïò§ÎäòÏùò ÎßêÏîÄ
            db.ref('dailyVerses').on('value', function(snap) {
                dailyVerses = {};
                snap.forEach(function(c) {
                    dailyVerses[c.key] = c.val();
                });
                console.log('ÎßêÏîÄ Î°úÎìú:', Object.keys(dailyVerses).length + 'Í∞ú');
                displayTodayVerse();
            });
        }

        // ========== Ïú†Ìã∏Î¶¨Ìã∞ ==========
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        function openModal(id) { document.getElementById(id).classList.add('active'); }
        
        function showSection(id, btn) {
            document.querySelectorAll('.section').forEach(function(s) { s.classList.remove('active'); });
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(function(n) { n.classList.remove('active'); });
            if (btn) btn.classList.add('active');
        }

        function togglePanel(panelId, btn) {
            var panel = document.getElementById(panelId);
            panel.classList.toggle('show');
            btn.textContent = panel.classList.contains('show') ? '‚úï Îã´Í∏∞' : '‚ûï ' + (panelId === 'noticeAdminPanel' ? 'Í≥µÏßÄ Îì±Î°ùÌïòÍ∏∞' : 'Í≤åÏãúÍ∏Ä Îì±Î°ùÌïòÍ∏∞');
        }

        function showToast(msg) {
            var t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.add('show');
            setTimeout(function() { t.classList.remove('show'); }, 2000);
        }

        function formatDate(str) {
            if (!str) return '';
            var d = new Date(str);
            return (d.getMonth()+1) + '/' + d.getDate();
        }

        function formatDateTime(str) {
            if (!str) return '';
            var d = new Date(str);
            return d.getFullYear() + 'ÎÖÑ ' + (d.getMonth()+1) + 'Ïõî ' + d.getDate() + 'Ïùº';
        }

        function linkify(text) {
            if (!text) return '';
            // URL Ìå®ÌÑ¥ Í∞êÏßÄ (http, https, www)
            var urlPattern = /(https?:\/\/[^\s<]+|www\.[^\s<]+)/gi;
            return text.replace(urlPattern, function(url) {
                var href = url;
                if (url.indexOf('http') !== 0) {
                    href = 'https://' + url;
                }
                return '<a href="' + href + '" target="_blank" class="auto-link">' + url + '</a>';
            });
        }

        function setDailyVerse() {
            // FirebaseÏóêÏÑú Î°úÎìúÎêú ÎßêÏîÄÏù¥ ÏûàÏúºÎ©¥ Í∑∏Í≤ÉÏùÑ ÏÇ¨Ïö©
            displayTodayVerse();
        }

        function displayTodayVerse() {
            var today = new Date().getDate();
            var verse = dailyVerses[today];
            
            if (verse && verse.text) {
                document.getElementById('dailyVerse').textContent = '"' + verse.text + '"';
                document.getElementById('verseReference').textContent = verse.reference || '';
            } else {
                // Í∏∞Î≥∏ ÎßêÏîÄ (FirebaseÏóê Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏùÑ Îïå)
                var defaultVerses = [
                    { text: "Ìï≠ÏÉÅ Í∏∞ÎªêÌïòÎùº Ïâ¨ÏßÄ ÎßêÍ≥† Í∏∞ÎèÑÌïòÎùº Î≤îÏÇ¨Ïóê Í∞êÏÇ¨ÌïòÎùº", reference: "Îç∞ÏÇ¥Î°úÎãàÍ∞ÄÏ†ÑÏÑú 5:16-18" },
                    { text: "Ïó¨Ìò∏ÏôÄÎäî ÎÇòÏùò Î™©ÏûêÏãúÎãà ÎÇ¥Í≤å Î∂ÄÏ°±Ìï®Ïù¥ ÏóÜÏúºÎ¶¨Î°úÎã§", reference: "ÏãúÌé∏ 23:1" },
                    { text: "ÎëêÎ†§ÏõåÌïòÏßÄ ÎßêÎùº ÎÇ¥Í∞Ä ÎÑàÏôÄ Ìï®Íªò Ìï®Ïù¥Îùº", reference: "Ïù¥ÏÇ¨Ïïº 41:10" }
                ];
                var idx = today % defaultVerses.length;
                document.getElementById('dailyVerse').textContent = '"' + defaultVerses[idx].text + '"';
                document.getElementById('verseReference').textContent = defaultVerses[idx].reference;
            }
        }

        function openVerseModal() {
            renderVerseInputs();
            openModal('verseModal');
        }

        function switchVerseTab(tab) {
            document.querySelectorAll('.verse-tab').forEach(function(t) { t.classList.remove('active'); });
            document.querySelectorAll('.verse-tab-content').forEach(function(c) { c.classList.remove('active'); });
            
            if (tab === 'upload') {
                document.querySelector('.verse-tab:first-child').classList.add('active');
                document.getElementById('verseUploadTab').classList.add('active');
            } else {
                document.querySelector('.verse-tab:last-child').classList.add('active');
                document.getElementById('verseManualTab').classList.add('active');
                renderVerseInputs();
            }
        }

        function handleVerseFile(input) {
            var file = input.files[0];
            if (!file) return;

            var fileName = file.name.toLowerCase();
            
            if (fileName.endsWith('.docx')) {
                // Word ÌååÏùº Ï≤òÎ¶¨
                var reader = new FileReader();
                reader.onload = function(e) {
                    mammoth.extractRawText({ arrayBuffer: e.target.result })
                        .then(function(result) {
                            document.getElementById('verseTextArea').value = result.value;
                            showToast('ÌååÏùºÏùÑ Î∂àÎü¨ÏôîÏäµÎãàÎã§. "ÎßêÏîÄ Î∂àÎü¨Ïò§Í∏∞" Î≤ÑÌäºÏùÑ ÎàåÎü¨Ï£ºÏÑ∏Ïöî.');
                        })
                        .catch(function(err) {
                            console.error('docx ÌååÏã± ÏóêÎü¨:', err);
                            showToast('ÌååÏùº ÏùΩÍ∏∞ Ïã§Ìå®');
                        });
                };
                reader.readAsArrayBuffer(file);
            } else if (fileName.endsWith('.txt')) {
                // ÌÖçÏä§Ìä∏ ÌååÏùº Ï≤òÎ¶¨
                var reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('verseTextArea').value = e.target.result;
                    showToast('ÌååÏùºÏùÑ Î∂àÎü¨ÏôîÏäµÎãàÎã§. "ÎßêÏîÄ Î∂àÎü¨Ïò§Í∏∞" Î≤ÑÌäºÏùÑ ÎàåÎü¨Ï£ºÏÑ∏Ïöî.');
                };
                reader.readAsText(file, 'UTF-8');
            } else {
                showToast('ÏßÄÏõêÌïòÏßÄ ÏïäÎäî ÌååÏùº ÌòïÏãùÏûÖÎãàÎã§');
            }
        }

        function parseAndSaveVerses() {
            var text = document.getElementById('verseTextArea').value.trim();
            if (!text) {
                showToast('ÌÖçÏä§Ìä∏Î•º ÏûÖÎ†•ÌïòÍ±∞ÎÇò ÌååÏùºÏùÑ ÏóÖÎ°úÎìúÌï¥Ï£ºÏÑ∏Ïöî');
                return;
            }

            var lines = text.split('\n').map(function(l) { return l.trim(); }).filter(function(l) { return l; });
            var parsedVerses = {};
            var currentDay = null;

            for (var i = 0; i < lines.length; i++) {
                var line = lines[i];
                
                // ÎÇ†Ïßú Ìå®ÌÑ¥ Ï∞æÍ∏∞: "1Ïõî 1Ïùº", "1Ïùº", "01Ïùº" Îì±
                var dayMatch = line.match(/(\d{1,2})Ïõî\s*(\d{1,2})Ïùº/) || line.match(/^(\d{1,2})Ïùº/);
                
                if (dayMatch) {
                    // ÎÇ†Ïßú Ï§Ñ Î∞úÍ≤¨
                    currentDay = parseInt(dayMatch[dayMatch.length - 1]);
                } else if (currentDay && line.length > 5) {
                    // ÎßêÏîÄ Ï§Ñ (ÎÇ†ÏßúÍ∞Ä ÏÑ§Ï†ïÎêú ÏÉÅÌÉúÏóêÏÑú Ï∂©Î∂ÑÌûà Í∏¥ ÌÖçÏä§Ìä∏)
                    // Ï∂úÏ≤òÏôÄ ÎÇ¥Ïö© Î∂ÑÎ¶¨: "ÏãúÌé∏ 90:12 Ïö∞Î¶¨ÏóêÍ≤å..." ÎòêÎäî "ÎßàÌÉúÎ≥µÏùå 6:33 Í∑∏Îü∞Ï¶â..."
                    var verseMatch = line.match(/^([Í∞Ä-Ìû£]+\s*\d+:\d+[-\d]*)\s+(.+)$/);
                    
                    if (verseMatch) {
                        parsedVerses[currentDay] = {
                            reference: verseMatch[1],
                            text: verseMatch[2]
                        };
                    } else {
                        // Ï∂úÏ≤ò Ìå®ÌÑ¥Ïù¥ Îã§Î•º Í≤ΩÏö∞ Ï†ÑÏ≤¥Î•º ÌÖçÏä§Ìä∏Î°ú
                        parsedVerses[currentDay] = {
                            reference: '',
                            text: line
                        };
                    }
                    currentDay = null; // Îã§Ïùå ÎÇ†ÏßúÎ•º Í∏∞Îã§Î¶º
                }
            }

            var count = Object.keys(parsedVerses).length;
            
            if (count === 0) {
                showToast('ÎßêÏîÄÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§. ÌòïÏãùÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            // FirebaseÏóê Ï†ÄÏû•
            if (!db) {
                showToast('Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ïó∞Í≤∞ Ïã§Ìå®');
                return;
            }

            db.ref('dailyVerses').set(parsedVerses).then(function() {
                showToast(count + 'Í∞ú ÎßêÏîÄÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!');
                document.getElementById('verseTextArea').value = '';
                closeModal('verseModal');
            }).catch(function(e) {
                console.error('Ï†ÄÏû• Ïã§Ìå®:', e);
                showToast('Ï†ÄÏû• Ïã§Ìå®');
            });
        }

        function renderVerseInputs() {
            var container = document.getElementById('verseListContainer');
            var html = '';
            
            for (var day = 1; day <= 31; day++) {
                var verse = dailyVerses[day] || { text: '', reference: '' };
                html += '<div class="verse-input-group">';
                html += '<span class="verse-day">' + day + 'Ïùº</span>';
                html += '<input type="text" id="verseText' + day + '" placeholder="ÎßêÏîÄ ÎÇ¥Ïö©" value="' + (verse.text || '').replace(/"/g, '&quot;') + '">';
                html += '<input type="text" id="verseRef' + day + '" placeholder="Ï∂úÏ≤ò" value="' + (verse.reference || '').replace(/"/g, '&quot;') + '" style="flex:1;">';
                html += '</div>';
            }
            
            container.innerHTML = html;
        }

        function saveAllVerses() {
            if (!db) { showToast('Ïó∞Í≤∞ Ïã§Ìå®'); return; }
            
            var versesToSave = {};
            var count = 0;
            
            for (var day = 1; day <= 31; day++) {
                var text = document.getElementById('verseText' + day).value.trim();
                var reference = document.getElementById('verseRef' + day).value.trim();
                
                if (text) {
                    versesToSave[day] = { text: text, reference: reference };
                    count++;
                }
            }
            
            db.ref('dailyVerses').set(versesToSave).then(function() {
                showToast(count + 'Í∞ú ÎßêÏîÄÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§');
                closeModal('verseModal');
            }).catch(function(e) {
                console.error('Ï†ÄÏû• Ïã§Ìå®:', e);
                showToast('Ï†ÄÏû• Ïã§Ìå®');
            });
        }

        function clearAllVerses() {
            if (!confirm('Î™®Îì† ÎßêÏîÄÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;
            
            for (var day = 1; day <= 31; day++) {
                document.getElementById('verseText' + day).value = '';
                document.getElementById('verseRef' + day).value = '';
            }
            showToast('ÏûÖÎ†•ÎûÄÏù¥ Ï¥àÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§');
        }

        function loadSampleVerses() {
            var samples = [
                { text: "Ìï≠ÏÉÅ Í∏∞ÎªêÌïòÎùº Ïâ¨ÏßÄ ÎßêÍ≥† Í∏∞ÎèÑÌïòÎùº Î≤îÏÇ¨Ïóê Í∞êÏÇ¨ÌïòÎùº", reference: "Îç∞ÏÇ¥Î°úÎãàÍ∞ÄÏ†ÑÏÑú 5:16-18" },
                { text: "Ïó¨Ìò∏ÏôÄÎäî ÎÇòÏùò Î™©ÏûêÏãúÎãà ÎÇ¥Í≤å Î∂ÄÏ°±Ìï®Ïù¥ ÏóÜÏúºÎ¶¨Î°úÎã§", reference: "ÏãúÌé∏ 23:1" },
                { text: "ÎëêÎ†§ÏõåÌïòÏßÄ ÎßêÎùº ÎÇ¥Í∞Ä ÎÑàÏôÄ Ìï®Íªò Ìï®Ïù¥Îùº", reference: "Ïù¥ÏÇ¨Ïïº 41:10" },
                { text: "ÎÑàÌù¨ ÏóºÎ†§Î•º Îã§ Ï£ºÍªò Îß°Í∏∞Îùº Ïù¥Îäî Í∑∏Í∞Ä ÎÑàÌù¨Î•º ÎèåÎ≥¥Ïã¨Ïù¥Îùº", reference: "Î≤†ÎìúÎ°úÏ†ÑÏÑú 5:7" },
                { text: "ÎÇ¥Í∞Ä ÎÑàÎ•º Í∞ïÌïòÍ≤å ÌïòÎ¶¨Îùº Ï∞∏ÏúºÎ°ú ÎÑàÎ•º ÎèÑÏôÄÏ£ºÎ¶¨Îùº", reference: "Ïù¥ÏÇ¨Ïïº 41:10" },
                { text: "Ï£ºÎäî ÎÇòÏùò ÎπõÏù¥Ïöî ÎÇòÏùò Íµ¨ÏõêÏù¥ÏãúÎãà ÎÇ¥Í∞Ä ÎàÑÍµ¨Î•º ÎëêÎ†§ÏõåÌïòÎ¶¨Ïöî", reference: "ÏãúÌé∏ 27:1" },
                { text: "ÌïòÎÇòÎãòÏù¥ ÏÑ∏ÏÉÅÏùÑ Ïù¥Ï≤òÎüº ÏÇ¨ÎûëÌïòÏÇ¨ ÎèÖÏÉùÏûêÎ•º Ï£ºÏÖ®ÏúºÎãà", reference: "ÏöîÌïúÎ≥µÏùå 3:16" },
                { text: "ÎÇ¥Í∞Ä ÏßÑÏã§Î°ú ÎÑàÌù¨ÏóêÍ≤å Ïù¥Î•¥ÎÖ∏Îãà Î¨¥ÏóáÏù¥Îì†ÏßÄ Í∏∞ÎèÑÌïòÍ≥† Íµ¨ÌïòÎäî Í≤ÉÏùÄ Î∞õÏùÄ Ï§ÑÎ°ú ÎØøÏúºÎùº", reference: "ÎßàÍ∞ÄÎ≥µÏùå 11:24" },
                { text: "Î≤îÏÇ¨Ïóê Í∞êÏÇ¨ÌïòÎùº Ïù¥Í≤ÉÏù¥ Í∑∏Î¶¨Ïä§ÎèÑ ÏòàÏàò ÏïàÏóêÏÑú ÎÑàÌù¨Î•º Ìñ•ÌïòÏã† ÌïòÎÇòÎãòÏùò ÎúªÏù¥ÎãàÎùº", reference: "Îç∞ÏÇ¥Î°úÎãàÍ∞ÄÏ†ÑÏÑú 5:18" },
                { text: "ÎÇòÏùò ÌïòÎÇòÎãòÏù¥ Í∑∏Î¶¨Ïä§ÎèÑ ÏòàÏàò ÏïàÏóêÏÑú ÏòÅÍ¥ë Í∞ÄÏö¥Îç∞ Í∑∏ ÌíçÏÑ±Ìïú ÎåÄÎ°ú ÎÑàÌù¨ Î™®Îì† Ïì∏ Í≤ÉÏùÑ Ï±ÑÏö∞ÏãúÎ¶¨Îùº", reference: "ÎπåÎ¶ΩÎ≥¥ÏÑú 4:19" },
                { text: "Ï£ºÎ•º ÏïôÎßùÌïòÎäî ÏûêÎäî ÏÉà ÌûòÏùÑ ÏñªÏúºÎ¶¨Îãà ÎèÖÏàòÎ¶¨Í∞Ä ÎÇ†Í∞úÏπòÎ©∞ Ïò¨ÎùºÍ∞ê Í∞ôÏùÑ Í≤ÉÏù¥Ïöî", reference: "Ïù¥ÏÇ¨Ïïº 40:31" },
                { text: "Ïó¨Ìò∏ÏôÄÎ•º Í∏∞ÎªêÌïòÎùº Í∑∏Í∞Ä ÎÑ§ ÎßàÏùåÏùò ÏÜåÏõêÏùÑ ÎÑ§Í≤å Ïù¥Î£®Ïñ¥ Ï£ºÏãúÎ¶¨Î°úÎã§", reference: "ÏãúÌé∏ 37:4" },
                { text: "Ïù¥Î•¥ÏãúÎêò ÎÇ¥ ÏùÄÌòúÍ∞Ä ÎÑ§Í≤å Ï°±ÌïòÎèÑÎã§ Ïù¥Îäî ÎÇ¥ Îä•Î†•Ïù¥ ÏïΩÌïú Îç∞ÏÑú Ïò®Ï†ÑÌïòÏó¨ÏßêÏù¥Îùº", reference: "Í≥†Î¶∞ÎèÑÌõÑÏÑú 12:9" },
                { text: "ÌèâÏïàÏùÑ ÎÑàÌù¨ÏóêÍ≤å ÎÅºÏπòÎÖ∏Îãà Í≥ß ÎÇòÏùò ÌèâÏïàÏùÑ ÎÑàÌù¨ÏóêÍ≤å Ï£ºÎÖ∏Îùº", reference: "ÏöîÌïúÎ≥µÏùå 14:27" },
                { text: "ÎÇ¥Í∞Ä ÎÑàÌù¨ÏóêÍ≤å Î∂ÑÎ∂ÄÌïú Í≤ÉÏùÑ Í∞ÄÎ•¥Ï≥ê ÏßÄÌÇ§Í≤å ÌïòÎùº Î≥ºÏßÄÏñ¥Îã§ ÎÇ¥Í∞Ä ÏÑ∏ÏÉÅ ÎÅùÎÇ†ÍπåÏßÄ ÎÑàÌù¨ÏôÄ Ìï≠ÏÉÅ Ìï®Íªò ÏûàÏúºÎ¶¨Îùº", reference: "ÎßàÌÉúÎ≥µÏùå 28:20" },
                { text: "Ïò§ÏßÅ ÏÑ±Î†πÏùò Ïó¥Îß§Îäî ÏÇ¨ÎûëÍ≥º Ìù¨ÎùΩÍ≥º ÌôîÌèâÍ≥º Ïò§Îûò Ï∞∏ÏùåÍ≥º ÏûêÎπÑÏôÄ ÏñëÏÑ†Í≥º Ï∂©ÏÑ±Í≥º Ïò®Ïú†ÏôÄ Ï†àÏ†úÎãà", reference: "Í∞àÎùºÎîîÏïÑÏÑú 5:22-23" },
                { text: "ÎÑàÌù¨Îäî ÏÑ∏ÏÉÅÏùò ÎπõÏù¥Îùº ÏÇ∞ ÏúÑÏóê ÏûàÎäî ÎèôÎÑ§Í∞Ä Ïà®Í≤®ÏßÄÏßÄ Î™ªÌï† Í≤ÉÏù¥Ïöî", reference: "ÎßàÌÉúÎ≥µÏùå 5:14" },
                { text: "ÎØøÏùåÏùÄ Î∞îÎùºÎäî Í≤ÉÎì§Ïùò Ïã§ÏÉÅÏù¥Ïöî Î≥¥Ïù¥ÏßÄ ÏïäÎäî Í≤ÉÎì§Ïùò Ï¶ùÍ±∞Îãà", reference: "ÌûàÎ∏åÎ¶¨ÏÑú 11:1" },
                { text: "ÎÑ§ ÏãúÏûëÏùÄ ÎØ∏ÏïΩÌïòÏòÄÏúºÎÇò ÎÑ§ ÎÇòÏ§ëÏùÄ Ïã¨Ìûà Ï∞ΩÎåÄÌïòÎ¶¨Îùº", reference: "Ïö•Í∏∞ 8:7" },
                { text: "ÎÇòÎäî Ìè¨ÎèÑÎÇòÎ¨¥Ïöî ÎÑàÌù¨Îäî Í∞ÄÏßÄÎùº Í∑∏Í∞Ä ÎÇ¥ ÏïàÏóê, ÎÇ¥Í∞Ä Í∑∏ ÏïàÏóê Í±∞ÌïòÎ©¥ ÏÇ¨ÎûåÏù¥ Ïó¥Îß§Î•º ÎßéÏù¥ Îß∫ÎÇòÎãà", reference: "ÏöîÌïúÎ≥µÏùå 15:5" },
                { text: "ÎÑàÌù¨ ÎßàÏùåÏóê Í∑∏Î¶¨Ïä§ÎèÑÏùò ÌèâÍ∞ïÏù¥ Îã§Ïä§Î¶¨Í≤å ÌïòÎùº", reference: "Í≥®Î°úÏÉàÏÑú 3:15" },
                { text: "ÏÑ∏ÏÉÅÏóêÏÑúÎäî ÎÑàÌù¨Í∞Ä ÌôòÎÇúÏùÑ ÎãπÌïòÎÇò Îã¥ÎåÄÌïòÎùº ÎÇ¥Í∞Ä ÏÑ∏ÏÉÅÏùÑ Ïù¥Í∏∞ÏóàÎÖ∏Îùº", reference: "ÏöîÌïúÎ≥µÏùå 16:33" },
                { text: "Ïö∞Î¶¨Í∞Ä ÏïåÍ±∞ÎãàÏôÄ ÌïòÎÇòÎãòÏùÑ ÏÇ¨ÎûëÌïòÎäî Ïûê Í≥ß Í∑∏Ïùò ÎúªÎåÄÎ°ú Î∂ÄÎ•¥Ïã¨ÏùÑ ÏûÖÏùÄ ÏûêÎì§ÏóêÍ≤åÎäî Î™®Îì† Í≤ÉÏù¥ Ìï©Î†•ÌïòÏó¨ ÏÑ†ÏùÑ Ïù¥Î£®ÎäêÎãàÎùº", reference: "Î°úÎßàÏÑú 8:28" },
                { text: "ÎÑ§Í∞Ä ÎßåÏùº ÎØøÏúºÎ©¥ ÌïòÎÇòÎãòÏùò ÏòÅÍ¥ëÏùÑ Î≥¥Î¶¨Îùº", reference: "ÏöîÌïúÎ≥µÏùå 11:40" },
                { text: "ÌïòÎÇòÎãòÏùÄ ÏÇ¨ÎûëÏù¥ÏãúÎùº", reference: "ÏöîÌïúÏùºÏÑú 4:8" },
                { text: "ÎÇ¥Í∞Ä Í≥ß Í∏∏Ïù¥Ïöî ÏßÑÎ¶¨Ïöî ÏÉùÎ™ÖÏù¥Îãà ÎÇòÎ°ú ÎßêÎØ∏ÏïîÏßÄ ÏïäÍ≥†Îäî ÏïÑÎ≤ÑÏßÄÍªòÎ°ú Ïò¨ ÏûêÍ∞Ä ÏóÜÎäêÎãàÎùº", reference: "ÏöîÌïúÎ≥µÏùå 14:6" },
                { text: "Ï£º ÏòàÏàòÎ•º ÎØøÏúºÎùº Í∑∏Î¶¨ÌïòÎ©¥ ÎÑàÏôÄ ÎÑ§ ÏßëÏù¥ Íµ¨ÏõêÏùÑ Î∞õÏúºÎ¶¨Îùº", reference: "ÏÇ¨ÎèÑÌñâÏ†Ñ 16:31" },
                { text: "Ïó¨Ìò∏ÏôÄÍªòÏÑú ÎÑ§Í∞Ä Í∞ÄÎäî Î™®Îì† Í∏∏ÏóêÏÑú ÎÑàÎ•º ÏßÄÏºú Ï£ºÏãúÎ¶¨Î°úÎã§", reference: "ÏãúÌé∏ 121:8" },
                { text: "Ï≤≠Ìï®ÏùÑ Î∞õÏùÄ ÏûêÎäî ÎßéÎêò ÌÉùÌï®ÏùÑ ÏûÖÏùÄ ÏûêÎäî Ï†ÅÏúºÎãàÎùº", reference: "ÎßàÌÉúÎ≥µÏùå 22:14" },
                { text: "ÏàòÍ≥†ÌïòÍ≥† Î¨¥Í±∞Ïö¥ Ïßê ÏßÑ ÏûêÎì§ÏïÑ Îã§ ÎÇ¥Í≤åÎ°ú Ïò§Îùº ÎÇ¥Í∞Ä ÎÑàÌù¨Î•º Ïâ¨Í≤å ÌïòÎ¶¨Îùº", reference: "ÎßàÌÉúÎ≥µÏùå 11:28" },
                { text: "Ïó¨Ìò∏ÏôÄÎäî ÎÇòÏùò Î™©ÏûêÏãúÎãà ÎÇ¥Í≤å Î∂ÄÏ°±Ìï®Ïù¥ ÏóÜÏúºÎ¶¨Î°úÎã§", reference: "ÏãúÌé∏ 23:1" }
            ];
            
            for (var day = 1; day <= 31; day++) {
                document.getElementById('verseText' + day).value = samples[day - 1].text;
                document.getElementById('verseRef' + day).value = samples[day - 1].reference;
            }
            showToast('ÏÉòÌîå ÎßêÏîÄÏù¥ Î∂àÎü¨ÏôÄÏ°åÏäµÎãàÎã§. Ï†ÄÏû•ÏùÑ ÎàåÎü¨Ï£ºÏÑ∏Ïöî.');
        }

        // ========== ÏïÑÏù¥ÏΩò ÌîºÏª§ ==========
        function initIconPickers() {
            var linkPicker = document.getElementById('iconPicker');
            linkPicker.innerHTML = linkIcons.map(function(icon) {
                return '<div class="icon-option' + (icon === selectedIcon ? ' selected' : '') + '" onclick="selectLinkIcon(\'' + icon + '\')">' + icon + '</div>';
            }).join('');

            var deptPicker = document.getElementById('deptIconPicker');
            deptPicker.innerHTML = deptIcons.map(function(icon) {
                return '<div class="icon-option' + (icon === selectedDeptIcon ? ' selected' : '') + '" onclick="selectDeptIcon(\'' + icon + '\')">' + icon + '</div>';
            }).join('');
        }

        function selectLinkIcon(icon) {
            selectedIcon = icon;
            document.querySelectorAll('#iconPicker .icon-option').forEach(function(o) {
                o.classList.toggle('selected', o.textContent === icon);
            });
        }

        function selectDeptIcon(icon) {
            selectedDeptIcon = icon;
            document.querySelectorAll('#deptIconPicker .icon-option').forEach(function(o) {
                o.classList.toggle('selected', o.textContent === icon);
            });
        }

        // ========== Ï¶êÍ≤®Ï∞æÍ∏∞ ==========
        function renderQuickLinks() {
            // order Í∏∞Ï§Ä Ï†ïÎ†¨
            var sortedLinks = links.slice().sort(function(a, b) {
                return (a.order || 0) - (b.order || 0);
            });
            var html = sortedLinks.map(function(l) {
                return '<a href="' + l.url + '" target="_blank" class="quick-link"><span class="link-icon">' + (l.icon || 'üîó') + '</span><span class="link-text">' + l.name + '</span></a>';
            }).join('');
            
            if (sortedLinks.length === 0) {
                html = '<p style="color:var(--text-light); text-align:center; padding:20px;">Ï¶êÍ≤®Ï∞æÍ∏∞Í∞Ä ÏóÜÏäµÎãàÎã§. Í¥ÄÎ¶¨ÏóêÏÑú Ï∂îÍ∞ÄÌïòÏÑ∏Ïöî.</p>';
            }
            
            document.getElementById('quickLinks').innerHTML = html;
        }

        function openLinkModal() {
            document.getElementById('linkEditId').value = '';
            document.getElementById('linkName').value = '';
            document.getElementById('linkUrl').value = '';
            document.getElementById('linkModalTitle').textContent = 'Ï¶êÍ≤®Ï∞æÍ∏∞ Ï∂îÍ∞Ä';
            document.getElementById('deleteLinkBtn').style.display = 'none';
            selectedIcon = 'üîó';
            initIconPickers();
            openModal('linkModal');
        }

        function editLink(id) {
            var link = links.find(function(l) { return l.id === id; });
            if (!link) return;
            document.getElementById('linkEditId').value = id;
            document.getElementById('linkName').value = link.name;
            document.getElementById('linkUrl').value = link.url;
            document.getElementById('linkModalTitle').textContent = 'Ï¶êÍ≤®Ï∞æÍ∏∞ ÏàòÏ†ï';
            document.getElementById('deleteLinkBtn').style.display = 'block';
            selectedIcon = link.icon || 'üîó';
            initIconPickers();
            openModal('linkModal');
        }

        function saveLink() {
            if (!db) { showToast('Ïó∞Í≤∞ Ïã§Ìå®'); return; }
            var id = document.getElementById('linkEditId').value;
            var name = document.getElementById('linkName').value.trim();
            var url = document.getElementById('linkUrl').value.trim();
            if (!name || !url) { showToast('Ïù¥Î¶ÑÍ≥º URLÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî'); return; }

            var data = { name: name, url: url, icon: selectedIcon };
            if (id) {
                db.ref('links/' + id).update(data).then(function() {
                    closeModal('linkModal');
                    showToast('Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§');
                });
            } else {
                // ÏÉà ÎßÅÌÅ¨Îäî ÎßàÏßÄÎßâ ÏàúÏÑúÎ°ú Ï∂îÍ∞Ä
                var maxOrder = links.reduce(function(max, l) {
                    return Math.max(max, l.order || 0);
                }, 0);
                data.order = maxOrder + 1;
                db.ref('links').push(data).then(function() {
                    closeModal('linkModal');
                    showToast('Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§');
                });
            }
        }

        function deleteLink() {
            if (!db) return;
            var id = document.getElementById('linkEditId').value;
            if (!confirm('ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;
            db.ref('links/' + id).remove().then(function() {
                closeModal('linkModal');
                showToast('ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§');
            });
        }

        var linkSortable = null;

        function openLinkManageModal() {
            renderLinkOrderList();
            openModal('linkOrderModal');
        }

        function renderLinkOrderList() {
            var container = document.getElementById('linkOrderList');
            // order Í∏∞Ï§Ä Ï†ïÎ†¨
            var sortedLinks = links.slice().sort(function(a, b) {
                return (a.order || 0) - (b.order || 0);
            });

            if (sortedLinks.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:var(--text-light);">Ï¶êÍ≤®Ï∞æÍ∏∞Í∞Ä ÏóÜÏäµÎãàÎã§</p>';
                return;
            }

            var html = sortedLinks.map(function(l) {
                return '<div class="link-order-item" data-id="' + l.id + '">' +
                    '<span class="drag-handle">‚ò∞</span>' +
                    '<span class="link-icon">' + (l.icon || 'üîó') + '</span>' +
                    '<span class="link-name">' + l.name + '</span>' +
                    '<div class="link-manage-btns">' +
                    '<button class="link-edit-btn" onclick="editLinkFromManage(\'' + l.id + '\')">‚úèÔ∏è</button>' +
                    '<button class="link-delete-btn" onclick="deleteLinkDirect(\'' + l.id + '\')">üóëÔ∏è</button>' +
                    '</div></div>';
            }).join('');

            container.innerHTML = html;

            // SortableJS Ï¥àÍ∏∞Ìôî
            if (linkSortable) {
                linkSortable.destroy();
            }

            linkSortable = new Sortable(container, {
                animation: 150,
                handle: '.drag-handle',
                ghostClass: 'sortable-ghost',
                chosenClass: 'sortable-chosen',
                onEnd: function(evt) {
                    saveLinkOrder();
                }
            });
        }

        function editLinkFromManage(id) {
            closeModal('linkOrderModal');
            editLink(id);
        }

        function deleteLinkDirect(id) {
            if (!db) return;
            var link = links.find(function(l) { return l.id === id; });
            if (!confirm('"' + (link ? link.name : '') + '" ÏùÑ(Î•º) ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;
            db.ref('links/' + id).remove().then(function() {
                showToast('ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§');
                renderLinkOrderList();
            });
        }

        function saveLinkOrder() {
            if (!db) return;

            var container = document.getElementById('linkOrderList');
            var items = container.querySelectorAll('.link-order-item');
            var updates = {};

            items.forEach(function(item, index) {
                var id = item.getAttribute('data-id');
                updates['links/' + id + '/order'] = index;
            });

            db.ref().update(updates).then(function() {
                showToast('ÏàúÏÑúÍ∞Ä Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§');
            });
        }

        // ========== Í≥µÏßÄÏÇ¨Ìï≠ ==========
        function addNotice() {
            if (!db) { showToast('Ïó∞Í≤∞ Ïã§Ìå®'); return; }
            var title = document.getElementById('noticeTitle').value.trim();
            var content = document.getElementById('noticeContent').value.trim();
            var important = document.getElementById('noticeImportant').checked;
            if (!title || !content) { showToast('Ï†úÎ™©Í≥º ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî'); return; }

            db.ref('notices').push({
                title: title, content: content, important: important,
                date: new Date().toISOString()
            }).then(function() {
                document.getElementById('noticeTitle').value = '';
                document.getElementById('noticeContent').value = '';
                document.getElementById('noticeImportant').checked = false;
                document.getElementById('noticeAdminPanel').classList.remove('show');
                showToast('Í≥µÏßÄÍ∞Ä Îì±Î°ùÎêòÏóàÏäµÎãàÎã§');
            });
        }

        function renderNotices() {
            var container = document.getElementById('noticeList');
            if (notices.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="icon">üì≠</div><p>Í≥µÏßÄÏÇ¨Ìï≠Ïù¥ ÏóÜÏäµÎãàÎã§</p></div>';
                return;
            }
            container.innerHTML = notices.map(function(n) {
                return '<div class="notice-item" onclick="openNoticeDetail(\'' + n.id + '\')"><div class="notice-header"><span class="notice-title">' + (n.important ? '<span class="notice-badge">Ï§ëÏöî</span>' : '') + n.title + '</span><span class="notice-date">' + formatDate(n.date) + '</span></div><button class="notice-delete" onclick="event.stopPropagation();deleteNotice(\'' + n.id + '\')">üóëÔ∏è</button></div>';
            }).join('');
        }

        function renderRecentNotices() {
            var container = document.getElementById('recentNotices');
            var recent = notices.slice(0, 3);
            if (recent.length === 0) {
                container.innerHTML = '<p style="color:var(--text-light)">Îì±Î°ùÎêú Í≥µÏßÄÍ∞Ä ÏóÜÏäµÎãàÎã§</p>';
                return;
            }
            container.innerHTML = recent.map(function(n) {
                return '<div class="notice-item" onclick="openNoticeDetail(\'' + n.id + '\')"><div class="notice-header"><span class="notice-title">' + (n.important ? '<span class="notice-badge">Ï§ëÏöî</span>' : '') + n.title + '</span><span class="notice-date">' + formatDate(n.date) + '</span></div></div>';
            }).join('');
        }

        function openNoticeDetail(id) {
            var n = notices.find(function(x) { return x.id === id; });
            if (!n) return;
            currentNoticeId = id;
            document.getElementById('noticeModalTitle').textContent = n.title;
            document.getElementById('noticeModalDate').textContent = formatDate(n.date);
            document.getElementById('noticeModalContent').textContent = n.content;
            renderComments(id);
            openModal('noticeModal');
        }

        function deleteNotice(id) {
            if (!db) return;
            if (!confirm('ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;
            db.ref('notices/' + id).remove();
            db.ref('comments/' + id).remove();
            showToast('ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§');
        }

        // ========== ÎåìÍ∏Ä ==========
        function renderComments(noticeId) {
            var container = document.getElementById('noticeComments');
            var list = comments[noticeId] || [];
            document.getElementById('commentCount').textContent = list.length > 0 ? '(' + list.length + ')' : '';

            if (list.length === 0) {
                container.innerHTML = '<p style="color:var(--text-light)">Ï≤´ ÎåìÍ∏ÄÏùÑ ÎÇ®Í≤®Î≥¥ÏÑ∏Ïöî!</p>';
                return;
            }
            container.innerHTML = list.map(function(c) {
                return '<div class="comment-item"><button class="comment-delete" onclick="deleteComment(\'' + noticeId + '\',\'' + c.id + '\')">√ó</button><div class="comment-header"><span class="comment-author">' + c.author + '</span><span class="comment-date">' + formatDateTime(c.date) + '</span></div><p class="comment-content">' + c.content + '</p></div>';
            }).join('');
        }

        function addComment() {
            if (!db || !currentNoticeId) return;
            var author = document.getElementById('commentAuthor').value.trim() || 'ÏùµÎ™Ö';
            var content = document.getElementById('commentContent').value.trim();
            if (!content) { showToast('ÎåìÍ∏ÄÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî'); return; }

            db.ref('comments/' + currentNoticeId).push({
                author: author, content: content, date: new Date().toISOString()
            }).then(function() {
                document.getElementById('commentAuthor').value = '';
                document.getElementById('commentContent').value = '';
                showToast('ÎåìÍ∏ÄÏù¥ Îì±Î°ùÎêòÏóàÏäµÎãàÎã§');
            });
        }

        function deleteComment(noticeId, commentId) {
            if (!db) return;
            if (!confirm('ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;
            db.ref('comments/' + noticeId + '/' + commentId).remove();
        }

        // ========== Í∏∞ÎèÑÏ†úÎ™© ==========
        function updatePrayerMonth() {
            var m = ['1Ïõî','2Ïõî','3Ïõî','4Ïõî','5Ïõî','6Ïõî','7Ïõî','8Ïõî','9Ïõî','10Ïõî','11Ïõî','12Ïõî'];
            document.getElementById('currentMonth').textContent = currentPrayerMonth.getFullYear() + 'ÎÖÑ ' + m[currentPrayerMonth.getMonth()];
        }

        function changeMonth(d) {
            currentPrayerMonth.setMonth(currentPrayerMonth.getMonth() + d);
            renderPrayers();
        }

        function openPrayerModal(editId) {
            document.getElementById('prayerEditId').value = '';
            document.getElementById('prayerAuthor').value = '';
            document.getElementById('prayerContent').value = '';
            document.getElementById('prayerModalTitle').textContent = 'Í∏∞ÎèÑÏ†úÎ™© Ïò¨Î¶¨Í∏∞';

            if (editId) {
                var p = prayers.find(function(x) { return x.id === editId; });
                if (p) {
                    document.getElementById('prayerEditId').value = editId;
                    document.getElementById('prayerAuthor').value = p.author;
                    document.getElementById('prayerContent').value = p.content;
                    document.getElementById('prayerModalTitle').textContent = 'Í∏∞ÎèÑÏ†úÎ™© ÏàòÏ†ï';
                }
            }
            openModal('prayerModal');
        }

        function savePrayer() {
            if (!db) { showToast('Ïó∞Í≤∞ Ïã§Ìå®'); return; }
            var editId = document.getElementById('prayerEditId').value;
            var author = document.getElementById('prayerAuthor').value.trim() || 'ÏùµÎ™Ö';
            var content = document.getElementById('prayerContent').value.trim();
            if (!content) { showToast('Í∏∞ÎèÑÏ†úÎ™©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî'); return; }

            var monthKey = currentPrayerMonth.getFullYear() + '-' + String(currentPrayerMonth.getMonth()+1).padStart(2,'0');
            var data = { author: author, content: content, date: new Date().toISOString(), month: monthKey };

            var promise = editId ? db.ref('prayers/' + editId).update(data) : db.ref('prayers').push(data);
            promise.then(function() {
                closeModal('prayerModal');
                showToast(editId ? 'ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§' : 'Îì±Î°ùÎêòÏóàÏäµÎãàÎã§');
            });
        }

        function renderPrayers() {
            updatePrayerMonth();
            var container = document.getElementById('prayerList');
            var monthKey = currentPrayerMonth.getFullYear() + '-' + String(currentPrayerMonth.getMonth()+1).padStart(2,'0');
            var filtered = prayers.filter(function(p) { return p.month === monthKey; });

            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="icon">üôè</div><p>Ïù¥Î≤à Îã¨ Í∏∞ÎèÑÏ†úÎ™©Ïù¥ ÏóÜÏäµÎãàÎã§</p></div>';
                return;
            }
            container.innerHTML = filtered.map(function(p) {
                return '<div class="prayer-item"><div class="prayer-actions"><button onclick="openPrayerModal(\'' + p.id + '\')">‚úèÔ∏è</button><button onclick="deletePrayer(\'' + p.id + '\')">üóëÔ∏è</button></div><p class="prayer-author">' + p.author + '</p><p class="prayer-content">' + p.content + '</p><p class="prayer-date">' + formatDate(p.date) + '</p></div>';
            }).join('');
        }

        function deletePrayer(id) {
            if (!db) return;
            if (!confirm('ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;
            db.ref('prayers/' + id).remove();
            showToast('ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§');
        }

        // ========== Í∞êÏÇ¨Ï†úÎ™© ==========
        function changeThanksMonth(d) {
            currentThanksMonth.setMonth(currentThanksMonth.getMonth() + d);
            renderThanks();
        }

        function renderThanks() {
            var container = document.getElementById('thanksList');
            var monthKey = currentThanksMonth.getFullYear() + '-' + String(currentThanksMonth.getMonth() + 1).padStart(2, '0');
            document.getElementById('currentThanksMonth').textContent = currentThanksMonth.getFullYear() + 'ÎÖÑ ' + (currentThanksMonth.getMonth() + 1) + 'Ïõî';

            var filtered = thanks.filter(function(t) {
                return t.month === monthKey;
            });

            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="icon">üíù</div><p>Ïù¥Î≤à Îã¨ Í∞êÏÇ¨Ï†úÎ™©Ïù¥ ÏóÜÏäµÎãàÎã§</p></div>';
                return;
            }
            container.innerHTML = filtered.map(function(t) {
                return '<div class="prayer-item thanks-item"><div class="prayer-actions"><button onclick="openThanksModal(\'' + t.id + '\')">‚úèÔ∏è</button><button onclick="deleteThanks(\'' + t.id + '\')">üóëÔ∏è</button></div><p class="prayer-author">' + (t.author || 'ÏùµÎ™Ö') + '</p><p class="prayer-content">' + t.content + '</p><p class="prayer-date">' + formatDate(t.date) + '</p></div>';
            }).join('');
        }

        function openThanksModal(editId) {
            document.getElementById('thanksEditId').value = '';
            document.getElementById('thanksAuthor').value = '';
            document.getElementById('thanksContent').value = '';
            document.getElementById('thanksModalTitle').textContent = 'Í∞êÏÇ¨Ï†úÎ™© Ïò¨Î¶¨Í∏∞';

            if (editId) {
                var t = thanks.find(function(x) { return x.id === editId; });
                if (t) {
                    document.getElementById('thanksEditId').value = editId;
                    document.getElementById('thanksAuthor').value = t.author || '';
                    document.getElementById('thanksContent').value = t.content || '';
                    document.getElementById('thanksModalTitle').textContent = 'Í∞êÏÇ¨Ï†úÎ™© ÏàòÏ†ï';
                }
            }
            openModal('thanksModal');
        }

        function saveThanks() {
            if (!db) { showToast('Ïó∞Í≤∞ Ïã§Ìå®'); return; }
            var editId = document.getElementById('thanksEditId').value;
            var author = document.getElementById('thanksAuthor').value.trim() || 'ÏùµÎ™Ö';
            var content = document.getElementById('thanksContent').value.trim();
            if (!content) { showToast('Í∞êÏÇ¨ ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî'); return; }

            var monthKey = currentThanksMonth.getFullYear() + '-' + String(currentThanksMonth.getMonth() + 1).padStart(2, '0');
            var data = { author: author, content: content, month: monthKey, date: new Date().toISOString() };

            var promise = editId ? db.ref('thanks/' + editId).update(data) : db.ref('thanks').push(data);
            promise.then(function() {
                closeModal('thanksModal');
                showToast(editId ? 'ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§' : 'Îì±Î°ùÎêòÏóàÏäµÎãàÎã§');
            });
        }

        function deleteThanks(id) {
            if (!db) return;
            if (!confirm('ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;
            db.ref('thanks/' + id).remove();
            showToast('ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§');
        }

        // ========== ÏùºÏ†ï ==========
        function changeCalendarMonth(d) {
            currentCalendarMonth.setMonth(currentCalendarMonth.getMonth() + d);
            selectedDate = null;
            document.getElementById('selectedDateInfo').style.display = 'none';
            renderCalendar();
            renderSchedules();
        }

        function selectDate(year, month, day) {
            if (month !== currentCalendarMonth.getMonth() || year !== currentCalendarMonth.getFullYear()) {
                currentCalendarMonth = new Date(year, month, 1);
                renderCalendar();
                renderSchedules();
            }
            selectedDate = year + '-' + String(month+1).padStart(2,'0') + '-' + String(day).padStart(2,'0');
            renderCalendar();
            showSelectedDateSchedules();
        }

        function showSelectedDateSchedules() {
            var container = document.getElementById('selectedDateInfo');
            var schedulesDiv = document.getElementById('selectedDateSchedules');
            var titleDiv = document.getElementById('selectedDateTitle');
            
            var filtered = schedules.filter(function(s) { return s.date === selectedDate; });
            var d = new Date(selectedDate + 'T00:00:00');
            var wd = ['Ïùº','Ïõî','Ìôî','Ïàò','Î™©','Í∏à','ÌÜ†'];
            
            titleDiv.textContent = 'üìÖ ' + (d.getMonth()+1) + 'Ïõî ' + d.getDate() + 'Ïùº (' + wd[d.getDay()] + ')';
            
            if (filtered.length === 0) {
                schedulesDiv.innerHTML = '<p style="color:var(--text-light)">Ïù¥ ÎÇ†ÏßúÏóê ÏùºÏ†ïÏù¥ ÏóÜÏäµÎãàÎã§</p>';
            } else {
                schedulesDiv.innerHTML = filtered.map(function(s) {
                    return '<div class="selected-schedule-item">' +
                        '<div class="schedule-actions">' +
                        '<button class="edit-btn" onclick="editSchedule(\'' + s.id + '\')" title="ÏàòÏ†ï">‚úèÔ∏è</button>' +
                        '<button class="delete-btn" onclick="deleteSchedule(\'' + s.id + '\')" title="ÏÇ≠Ï†ú">üóëÔ∏è</button>' +
                        '</div>' +
                        '<div class="schedule-title">üìå ' + linkify(s.title) + '</div>' +
                        (s.time ? '<div class="schedule-time">üïê ' + s.time + '</div>' : '') +
                        '</div>';
                }).join('');
            }
            container.style.display = 'block';
        }

        function openQuickScheduleModal(editId) {
            if (!selectedDate && !editId) { showToast('Î®ºÏ†Ä ÎÇ†ÏßúÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî'); return; }
            
            var d, wd = ['Ïùº','Ïõî','Ìôî','Ïàò','Î™©','Í∏à','ÌÜ†'];
            var dateGroup = document.getElementById('scheduleDateGroup');
            var dateInput = document.getElementById('quickScheduleDate');
            
            if (editId) {
                // ÏàòÏ†ï Î™®Îìú - ÎÇ†Ïßú Î≥ÄÍ≤Ω Í∞ÄÎä•
                var schedule = schedules.find(function(s) { return s.id === editId; });
                if (!schedule) return;
                
                d = new Date(schedule.date + 'T00:00:00');
                document.getElementById('scheduleEditId').value = editId;
                document.getElementById('quickScheduleTitle').textContent = '‚úèÔ∏è ÏùºÏ†ï ÏàòÏ†ï';
                document.getElementById('quickScheduleInput').value = schedule.title;
                document.getElementById('quickScheduleTime').value = schedule.time || '';
                document.getElementById('scheduleSubmitBtn').textContent = 'ÏàòÏ†ï';
                dateInput.value = schedule.date;
                dateGroup.style.display = 'block';
                selectedDate = schedule.date;
            } else {
                // Îì±Î°ù Î™®Îìú - ÎÇ†Ïßú Ïà®ÍπÄ (Ïù¥ÎØ∏ ÏÑ†ÌÉùÎê®)
                d = new Date(selectedDate + 'T00:00:00');
                document.getElementById('scheduleEditId').value = '';
                document.getElementById('quickScheduleTitle').textContent = 'üìÖ ' + (d.getMonth()+1) + 'Ïõî ' + d.getDate() + 'Ïùº (' + wd[d.getDay()] + ') ÏùºÏ†ï Îì±Î°ù';
                document.getElementById('quickScheduleInput').value = '';
                document.getElementById('quickScheduleTime').value = '';
                document.getElementById('scheduleSubmitBtn').textContent = 'Îì±Î°ù';
                dateGroup.style.display = 'none';
            }
            
            // textarea ÎÜíÏù¥ Ï¥àÍ∏∞Ìôî
            var textarea = document.getElementById('quickScheduleInput');
            textarea.style.height = 'auto';
            setTimeout(function() { autoResize(textarea); }, 10);
            
            openModal('quickScheduleModal');
        }

        function editSchedule(id) {
            openQuickScheduleModal(id);
        }

        function autoResize(el) {
            el.style.height = 'auto';
            el.style.height = Math.min(el.scrollHeight, 200) + 'px';
        }

        function saveQuickSchedule() {
            if (!db) { showToast('Ïó∞Í≤∞ Ïã§Ìå®'); return; }
            var editId = document.getElementById('scheduleEditId').value;
            var title = document.getElementById('quickScheduleInput').value.trim();
            var time = document.getElementById('quickScheduleTime').value.trim();
            if (!title) { showToast('ÏùºÏ†ï ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî'); return; }

            // ÏàòÏ†ï Î™®ÎìúÏùº ÎïåÎäî ÎÇ†Ïßú ÏûÖÎ†•Í∞í ÏÇ¨Ïö©, Îì±Î°ù Î™®ÎìúÏùº ÎïåÎäî selectedDate ÏÇ¨Ïö©
            var scheduleDate = editId 
                ? document.getElementById('quickScheduleDate').value 
                : selectedDate;
            
            if (!scheduleDate) { showToast('ÎÇ†ÏßúÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî'); return; }

            var data = { date: scheduleDate, title: title, time: time || '' };

            if (editId) {
                // ÏàòÏ†ï
                console.log('ÏùºÏ†ï ÏàòÏ†ï:', { id: editId, ...data });
                db.ref('schedules/' + editId).update(data).then(function() {
                    closeModal('quickScheduleModal');
                    showToast('ÏùºÏ†ïÏù¥ ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§');
                    renderCalendar();
                    renderSchedules();
                    if (selectedDate) showSelectedDateSchedules();
                }).catch(function(e) {
                    console.error('ÏàòÏ†ï Ïã§Ìå®:', e);
                    showToast('ÏàòÏ†ï Ïã§Ìå®');
                });
            } else {
                // Îì±Î°ù
                console.log('ÏùºÏ†ï Ï†ÄÏû•:', data);
                db.ref('schedules').push(data).then(function() {
                    console.log('Ï†ÄÏû• ÏÑ±Í≥µ');
                    closeModal('quickScheduleModal');
                    showToast('ÏùºÏ†ïÏù¥ Îì±Î°ùÎêòÏóàÏäµÎãàÎã§');
                }).catch(function(e) {
                    console.error('Ï†ÄÏû• Ïã§Ìå®:', e);
                    showToast('Îì±Î°ù Ïã§Ìå®');
                });
            }
        }

        function renderCalendar() {
            var m = ['1Ïõî','2Ïõî','3Ïõî','4Ïõî','5Ïõî','6Ïõî','7Ïõî','8Ïõî','9Ïõî','10Ïõî','11Ïõî','12Ïõî'];
            document.getElementById('calendarMonth').textContent = currentCalendarMonth.getFullYear() + 'ÎÖÑ ' + m[currentCalendarMonth.getMonth()];

            var grid = document.getElementById('calendarGrid');
            var year = currentCalendarMonth.getFullYear();
            var month = currentCalendarMonth.getMonth();
            var firstDay = new Date(year, month, 1).getDay();
            var totalDays = new Date(year, month+1, 0).getDate();
            var today = new Date();
            var todayStr = today.getFullYear() + '-' + String(today.getMonth()+1).padStart(2,'0') + '-' + String(today.getDate()).padStart(2,'0');
            var eventDates = schedules.map(function(s) { return s.date; });

            var html = '<div class="calendar-day-name">Ïùº</div><div class="calendar-day-name">Ïõî</div><div class="calendar-day-name">Ìôî</div><div class="calendar-day-name">Ïàò</div><div class="calendar-day-name">Î™©</div><div class="calendar-day-name">Í∏à</div><div class="calendar-day-name">ÌÜ†</div>';

            // Ïù¥Ï†Ñ Îã¨
            var prevMonth = month === 0 ? 11 : month - 1;
            var prevYear = month === 0 ? year - 1 : year;
            var prevLast = new Date(year, month, 0).getDate();
            for (var i = firstDay - 1; i >= 0; i--) {
                var day = prevLast - i;
                var dateStr = prevYear + '-' + String(prevMonth+1).padStart(2,'0') + '-' + String(day).padStart(2,'0');
                var hasEvent = eventDates.indexOf(dateStr) !== -1;
                html += '<div class="calendar-day other-month' + (hasEvent ? ' has-event' : '') + '" onclick="selectDate(' + prevYear + ',' + prevMonth + ',' + day + ')">' + day + '</div>';
            }

            // ÌòÑÏû¨ Îã¨
            for (var day = 1; day <= totalDays; day++) {
                var dateStr = year + '-' + String(month+1).padStart(2,'0') + '-' + String(day).padStart(2,'0');
                var cls = 'calendar-day';
                if (dateStr === todayStr) cls += ' today';
                if (dateStr === selectedDate) cls += ' selected';
                if (eventDates.indexOf(dateStr) !== -1) cls += ' has-event';
                if ((firstDay + day - 1) % 7 === 0) cls += ' sunday';
                html += '<div class="' + cls + '" onclick="selectDate(' + year + ',' + month + ',' + day + ')">' + day + '</div>';
            }

            // Îã§Ïùå Îã¨
            var nextMonth = month === 11 ? 0 : month + 1;
            var nextYear = month === 11 ? year + 1 : year;
            var rem = 42 - (firstDay + totalDays);
            for (var d = 1; d <= rem; d++) {
                var dateStr = nextYear + '-' + String(nextMonth+1).padStart(2,'0') + '-' + String(d).padStart(2,'0');
                var hasEvent = eventDates.indexOf(dateStr) !== -1;
                html += '<div class="calendar-day other-month' + (hasEvent ? ' has-event' : '') + '" onclick="selectDate(' + nextYear + ',' + nextMonth + ',' + d + ')">' + d + '</div>';
            }

            grid.innerHTML = html;
        }

        function renderSchedules(searchKeyword) {
            var container = document.getElementById('monthSchedules');
            var year = currentCalendarMonth.getFullYear();
            var month = currentCalendarMonth.getMonth();
            var monthKey = year + '-' + String(month+1).padStart(2,'0');
            var filtered;
            var isSearchMode = searchKeyword && searchKeyword.trim();
            
            if (isSearchMode) {
                // Í≤ÄÏÉâ Î™®Îìú: Ïù¥Ï†Ñ 1ÎÖÑ ~ Ïù¥ÌõÑ 5ÎÖÑ Î≤îÏúÑ
                var now = new Date();
                var startDate = new Date(now.getFullYear() - 1, now.getMonth(), 1);
                var endDate = new Date(now.getFullYear() + 5, now.getMonth(), 28);
                var startKey = startDate.getFullYear() + '-' + String(startDate.getMonth()+1).padStart(2,'0') + '-01';
                var endKey = endDate.getFullYear() + '-' + String(endDate.getMonth()+1).padStart(2,'0') + '-28';
                
                var keyword = searchKeyword.trim().toLowerCase();
                filtered = schedules.filter(function(s) {
                    if (!s.date || s.date < startKey || s.date > endKey) return false;
                    return (s.title && s.title.toLowerCase().indexOf(keyword) !== -1) ||
                           (s.time && s.time.toLowerCase().indexOf(keyword) !== -1);
                });
            } else {
                // ÏùºÎ∞ò Î™®Îìú: Ïù¥Î≤à Îã¨Îßå
                filtered = schedules.filter(function(s) { return s.date && s.date.indexOf(monthKey) === 0; });
            }
            
            filtered.sort(function(a, b) { return a.date.localeCompare(b.date); });
            var wd = ['Ïùº','Ïõî','Ìôî','Ïàò','Î™©','Í∏à','ÌÜ†'];

            if (filtered.length === 0) {
                if (isSearchMode) {
                    container.innerHTML = '<div class="empty-state"><div class="icon">üîç</div><p>Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§</p><p style="font-size:0.85rem;color:var(--text-light);">ÏµúÍ∑º 1ÎÖÑ ~ Ìñ•ÌõÑ 5ÎÖÑ Î≤îÏúÑ</p></div>';
                } else {
                    container.innerHTML = '<div class="empty-state"><div class="icon">üìÖ</div><p>Ïù¥Î≤à Îã¨ ÏùºÏ†ïÏù¥ ÏóÜÏäµÎãàÎã§</p></div>';
                }
                return;
            }

            container.innerHTML = filtered.map(function(s) {
                var d = new Date(s.date + 'T00:00:00');
                var dateDisplay = isSearchMode 
                    ? '<div class="schedule-day">' + (d.getMonth()+1) + '/' + d.getDate() + '</div><div class="schedule-weekday">' + d.getFullYear() + '</div>'
                    : '<div class="schedule-day">' + d.getDate() + '</div><div class="schedule-weekday">' + wd[d.getDay()] + '</div>';
                return '<div class="schedule-item">' +
                    '<div class="schedule-date">' + dateDisplay + '</div>' +
                    '<div class="schedule-info">' +
                    '<div class="schedule-title-row">' +
                    '<div class="schedule-title">' + linkify(s.title) + '</div>' +
                    '<div class="schedule-item-btns">' +
                    '<button class="edit-btn" onclick="editSchedule(\'' + s.id + '\')">‚úèÔ∏è</button>' +
                    '<button class="delete-btn" onclick="deleteSchedule(\'' + s.id + '\')">üóëÔ∏è</button>' +
                    '</div></div>' +
                    (s.time ? '<div class="schedule-time">üïê ' + s.time + '</div>' : '') +
                    '</div></div>';
            }).join('');
            
            // Í≤ÄÏÉâ Î™®ÎìúÏùº Îïå Í≤∞Í≥º Í∞úÏàò ÌëúÏãú
            if (isSearchMode) {
                container.insertAdjacentHTML('afterbegin', '<p style="font-size:0.85rem;color:var(--text-secondary);margin-bottom:12px;">üîç Í≤ÄÏÉâ Í≤∞Í≥º: ' + filtered.length + 'Í±¥ (ÏµúÍ∑º 1ÎÖÑ ~ Ìñ•ÌõÑ 5ÎÖÑ)</p>');
            }
        }

        function searchSchedules() {
            var keyword = document.getElementById('scheduleSearchInput').value;
            renderSchedules(keyword);
        }

        function deleteSchedule(id) {
            if (!db) return;
            if (!confirm('ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;
            db.ref('schedules/' + id).remove().then(function() {
                showToast('ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§');
            });
        }

        // ========== Î∂ÄÏÑú ==========
        function renderDeptTabs() {
            var container = document.getElementById('deptTabs');
            if (departments.length === 0) {
                container.innerHTML = '<p style="color:var(--text-light)">Î∂ÄÏÑúÍ∞Ä ÏóÜÏäµÎãàÎã§. "Î∂ÄÏÑú Í¥ÄÎ¶¨"ÏóêÏÑú Ï∂îÍ∞ÄÌïòÏÑ∏Ïöî.</p>';
                return;
            }
            container.innerHTML = departments.map(function(d) {
                return '<button class="dept-tab' + (currentDept === d.id ? ' active' : '') + '" onclick="switchDept(\'' + d.id + '\')">' + (d.icon || 'üë•') + ' ' + d.name + '</button>';
            }).join('');
        }

        function updateDeptSelect() {
            var select = document.getElementById('deptPostDept');
            if (departments.length > 0) {
                select.innerHTML = departments.map(function(d) { return '<option value="' + d.id + '">' + d.name + '</option>'; }).join('');
            } else {
                select.innerHTML = '<option value="">Î∂ÄÏÑúÎ•º Î®ºÏ†Ä Ï∂îÍ∞ÄÌïòÏÑ∏Ïöî</option>';
            }
        }

        function switchDept(id) {
            currentDept = id;
            renderDeptTabs();
            renderDeptPosts();
        }

        function openDeptManageModal() {
            renderDeptManageList();
            openModal('deptManageModal');
        }

        function renderDeptManageList() {
            var container = document.getElementById('deptManageList');
            if (departments.length === 0) {
                container.innerHTML = '<p style="color:var(--text-light); text-align:center;">Îì±Î°ùÎêú Î∂ÄÏÑúÍ∞Ä ÏóÜÏäµÎãàÎã§</p>';
                return;
            }
            container.innerHTML = departments.map(function(d) {
                return '<div class="dept-manage-item"><div class="dept-manage-info"><span class="dept-manage-icon">' + (d.icon || 'üë•') + '</span><span class="dept-manage-name">' + d.name + '</span></div><div class="dept-manage-actions"><button class="dept-edit-btn" onclick="editDept(\'' + d.id + '\')">‚úèÔ∏è ÏàòÏ†ï</button><button class="dept-delete-btn" onclick="deleteDept(\'' + d.id + '\')">üóëÔ∏è ÏÇ≠Ï†ú</button></div></div>';
            }).join('');
        }

        function openDeptAddModal() {
            document.getElementById('deptEditId').value = '';
            document.getElementById('deptName').value = '';
            document.getElementById('deptModalTitle').textContent = 'Î∂ÄÏÑú Ï∂îÍ∞Ä';
            selectedDeptIcon = 'üëî';
            initIconPickers();
            openModal('deptModal');
        }

        function editDept(id) {
            var dept = departments.find(function(d) { return d.id === id; });
            if (!dept) return;
            document.getElementById('deptEditId').value = id;
            document.getElementById('deptName').value = dept.name;
            document.getElementById('deptModalTitle').textContent = 'Î∂ÄÏÑú ÏàòÏ†ï';
            selectedDeptIcon = dept.icon || 'üëî';
            initIconPickers();
            closeModal('deptManageModal');
            openModal('deptModal');
        }

        function saveDept() {
            if (!db) { showToast('Ïó∞Í≤∞ Ïã§Ìå®'); return; }
            var id = document.getElementById('deptEditId').value;
            var name = document.getElementById('deptName').value.trim();
            if (!name) { showToast('Î∂ÄÏÑú Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî'); return; }

            console.log('Î∂ÄÏÑú Ï†ÄÏû•:', { id: id, name: name, icon: selectedDeptIcon });

            if (id) {
                db.ref('departments/' + id).update({ name: name, icon: selectedDeptIcon }).then(function() {
                    console.log('Î∂ÄÏÑú ÏàòÏ†ï ÏÑ±Í≥µ');
                    closeModal('deptModal');
                    showToast('Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§');
                }).catch(function(e) {
                    console.error('Î∂ÄÏÑú ÏàòÏ†ï Ïã§Ìå®:', e);
                    showToast('Ï†ÄÏû• Ïã§Ìå®');
                });
            } else {
                db.ref('departments').push({ name: name, icon: selectedDeptIcon, order: departments.length + 1 }).then(function() {
                    console.log('Î∂ÄÏÑú Ï∂îÍ∞Ä ÏÑ±Í≥µ');
                    closeModal('deptModal');
                    showToast('Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§');
                }).catch(function(e) {
                    console.error('Î∂ÄÏÑú Ï∂îÍ∞Ä Ïã§Ìå®:', e);
                    showToast('Ï†ÄÏû• Ïã§Ìå®');
                });
            }
        }

        function deleteDept(id) {
            if (!db) return;
            if (!confirm('Ïù¥ Î∂ÄÏÑúÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;
            db.ref('departments/' + id).remove();
            db.ref('deptPosts/' + id).remove();
            renderDeptManageList();
            showToast('ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§');
        }

        function togglePasswordField() {
            var checkbox = document.getElementById('deptPostLocked');
            var field = document.getElementById('passwordField');
            field.classList.toggle('active', checkbox.checked);
        }

        function renderDeptPosts() {
            var container = document.getElementById('deptContents');
            if (departments.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="icon">üë•</div><p>Î∂ÄÏÑúÎ•º Î®ºÏ†Ä Ï∂îÍ∞ÄÌï¥Ï£ºÏÑ∏Ïöî</p></div>';
                return;
            }
            if (!currentDept) {
                container.innerHTML = '<div class="empty-state"><div class="icon">üëÜ</div><p>Î∂ÄÏÑúÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî</p></div>';
                return;
            }
            var posts = deptPosts[currentDept] || [];
            if (posts.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="icon">üìù</div><p>Í≤åÏãúÍ∏ÄÏù¥ ÏóÜÏäµÎãàÎã§</p></div>';
                return;
            }

            container.innerHTML = posts.map(function(p) {
                return '<div class="dept-post' + (p.locked ? ' locked' : '') + '" onclick="openDeptPostDetail(\'' + currentDept + '\',\'' + p.id + '\')"><div class="dept-post-header"><span class="dept-post-title">' + (p.locked ? '<span class="lock-icon">üîí</span>' : '') + p.title + '</span><span class="dept-post-date">' + formatDate(p.date) + '</span></div><p class="dept-post-preview">' + (p.locked ? 'üîê ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÌïÑÏöîÌï©ÎãàÎã§' : (p.content.length > 100 ? p.content.substring(0,100) + '...' : p.content)) + '</p><button class="delete-btn" onclick="event.stopPropagation();deleteDeptPost(\'' + currentDept + '\',\'' + p.id + '\')">üóëÔ∏è ÏÇ≠Ï†ú</button></div>';
            }).join('');
        }

        function openDeptPostDetail(deptId, postId) {
            var posts = deptPosts[deptId] || [];
            var post = posts.find(function(p) { return p.id === postId; });
            if (!post) return;

            if (post.locked && post.password) {
                pendingPost = { deptId: deptId, post: post };
                document.getElementById('passwordInput').value = '';
                document.getElementById('passwordError').classList.remove('show');
                openModal('passwordModal');
            } else {
                showDeptPostContent(post);
            }
        }

        function showDeptPostContent(post) {
            document.getElementById('deptPostModalTitle').textContent = post.title;
            document.getElementById('deptPostModalBody').innerHTML = '<p style="color:var(--text-light); margin-bottom: 16px;">' + formatDateTime(post.date) + '</p><div style="line-height: 1.8; white-space: pre-wrap;">' + post.content + '</div>';
            openModal('deptPostModal');
        }

        function checkPassword() {
            if (!pendingPost) return;
            var input = document.getElementById('passwordInput').value;
            if (input === pendingPost.post.password) {
                closeModal('passwordModal');
                showDeptPostContent(pendingPost.post);
                pendingPost = null;
            } else {
                document.getElementById('passwordError').classList.add('show');
                document.getElementById('passwordInput').value = '';
            }
        }

        function addDeptPost() {
            if (!db) { showToast('Ïó∞Í≤∞ Ïã§Ìå®'); return; }
            var deptId = document.getElementById('deptPostDept').value;
            if (!deptId) { showToast('Î∂ÄÏÑúÎ•º Î®ºÏ†Ä Ï∂îÍ∞ÄÌï¥Ï£ºÏÑ∏Ïöî'); return; }
            var title = document.getElementById('deptPostTitle').value.trim();
            var content = document.getElementById('deptPostContent').value.trim();
            var locked = document.getElementById('deptPostLocked').checked;
            var password = document.getElementById('deptPostPassword').value.trim();
            if (!title || !content) { showToast('Ï†úÎ™©Í≥º ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî'); return; }
            if (locked && !password) { showToast('ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî'); return; }

            db.ref('deptPosts/' + deptId).push({
                title: title, content: content, date: new Date().toISOString(),
                locked: locked, password: locked ? password : null
            }).then(function() {
                document.getElementById('deptPostTitle').value = '';
                document.getElementById('deptPostContent').value = '';
                document.getElementById('deptPostLocked').checked = false;
                document.getElementById('deptPostPassword').value = '';
                document.getElementById('passwordField').classList.remove('active');
                document.getElementById('deptAdminPanel').classList.remove('show');
                showToast('Í≤åÏãúÍ∏ÄÏù¥ Îì±Î°ùÎêòÏóàÏäµÎãàÎã§');
            });
        }

        function deleteDeptPost(deptId, postId) {
            if (!db) return;
            if (!confirm('ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;
            db.ref('deptPosts/' + deptId + '/' + postId).remove();
            showToast('ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§');
        }
    </script>
</body>
</html>
